<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Deutsch Rad C1 — Полный тренажёр немецкого</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080810;
  --s1: #0f0f1c;
  --s2: #161625;
  --s3: #1e1e32;
  --border: rgba(255,255,255,0.07);
  --text: #dde0f0;
  --dim: #6a6a90;
  --dim2: #9090b8;
  --past: #d94f3a;
  --past2: #a33020;
  --past3: #7a1a10;
  --present: #3ad9a0;
  --present2: #20a368;
  --future: #3a8fd9;
  --future2: #206aa3;
  --special: #c97ae0;
  --gold: #e0c46a;
  --syntax: #e07a40;
  --nebensatz: #4ae0c0;
  --c1color: #ff6090;
  --wheel-size: 600px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Mono', monospace;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ── NAV ── */
nav {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  background: rgba(8,8,16,0.95);
  position: sticky; top: 0; z-index: 50;
  flex-wrap: wrap; gap: 8px;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.logo {
  font-family: 'EB Garamond', serif;
  font-size: 1.3rem; font-weight: 700;
  letter-spacing: 0.08em;
  background: linear-gradient(120deg, var(--past), var(--present), var(--future));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  white-space: nowrap;
}
.nav-legend {
  display: flex; gap: 12px; align-items: center;
  flex-wrap: wrap;
}
.nl { display: flex; align-items: center; gap: 5px; font-size: 0.55rem; color: var(--dim); letter-spacing: 0.06em; text-transform: uppercase; white-space: nowrap; }
.nd { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.nav-score { display: flex; gap: 14px; }
.ns { text-align: center; }
.ns-n { font-family: 'EB Garamond', serif; font-size: 1.1rem; }
.ns-l { font-size: 0.48rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.1em; }

/* Toggle legend on mobile */
.nav-toggle {
  display: none;
  background: none; border: 1px solid var(--border);
  color: var(--dim); font-size: 0.55rem; padding: 4px 10px;
  border-radius: 4px; cursor: pointer; font-family: inherit;
  letter-spacing: 0.08em; text-transform: uppercase;
}

/* ── LAYOUT ── */
.layout {
  display: flex;
  flex-direction: column;
  min-height: calc(100vh - 60px);
}

/* Desktop: side by side */
@media (min-width: 900px) {
  .layout {
    display: grid;
    grid-template-columns: 1fr 440px;
    min-height: calc(100vh - 60px);
  }
  .wheel-panel { overflow: auto; }
  .info-panel { overflow: hidden; display: flex; flex-direction: column; border-left: 1px solid var(--border); }
}

/* ── WHEEL PANEL ── */
.wheel-panel {
  display: flex; flex-direction: column;
  align-items: center;
  padding: 24px 16px 32px;
  gap: 16px;
  position: relative;
  background: var(--bg);
}
.wheel-panel::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(ellipse at center, rgba(58,137,217,0.04) 0%, transparent 70%);
  pointer-events: none;
}
.wheel-wrap {
  position: relative;
  width: var(--wheel-size);
  height: var(--wheel-size);
  flex-shrink: 0;
  max-width: 100%;
}
#wc {
  position: absolute; top: 0; left: 0;
  cursor: pointer;
  width: 100%; height: 100%;
}
.w-center {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  width: 80px; height: 80px; border-radius: 50%;
  background: var(--bg); border: 1px solid var(--border);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  font-size: 0.5rem; color: var(--dim); text-align: center;
  line-height: 1.5; letter-spacing: 0.06em; text-transform: uppercase;
  pointer-events: none; z-index: 5;
  transition: all 0.3s;
}

/* breadcrumb */
.bc {
  display: flex; align-items: center; gap: 6px;
  font-size: 0.6rem; color: var(--dim); flex-wrap: wrap;
  min-height: 20px; justify-content: center;
}
.bc-item { cursor: pointer; transition: color 0.2s; padding: 2px 8px; border-radius: 4px; }
.bc-item:hover { color: var(--text); background: var(--s2); }
.bc-sep { opacity: 0.35; }
.btn-back {
  font-family: 'DM Mono', monospace;
  font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase;
  padding: 8px 20px; background: transparent;
  border: 1px solid var(--border); color: var(--dim);
  cursor: pointer; border-radius: 6px; transition: all 0.2s;
}
.btn-back:hover { border-color: var(--dim2); color: var(--text); }

/* ── INFO PANEL ── */
.info-panel {
  background: var(--s1);
  display: flex; flex-direction: column;
  min-height: 50vh;
}
.ip-head {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.ip-tag { font-size: 0.55rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--dim); margin-bottom: 6px; }
.ip-title { font-family: 'EB Garamond', serif; font-size: 1.8rem; font-weight: 700; line-height: 1.1; }
.ip-sub { font-size: 0.65rem; color: var(--dim); margin-top: 5px; font-style: italic; }
.ip-body { flex: 1; overflow-y: auto; padding: 18px 24px; -webkit-overflow-scrolling: touch; }
.ip-body::-webkit-scrollbar { width: 3px; }
.ip-body::-webkit-scrollbar-thumb { background: var(--s3); }

/* Cards */
.card {
  background: var(--s2); border-radius: 8px;
  padding: 14px 16px; margin-bottom: 12px;
  border-left: 3px solid transparent;
  animation: fadeUp 0.3s ease;
}
.card.past   { border-color: var(--past); }
.card.present{ border-color: var(--present); }
.card.future { border-color: var(--future); }
.card.special{ border-color: var(--special); }
.card.gold   { border-color: var(--gold); }
.card.syntax { border-color: var(--syntax); }
.card.nebensatz { border-color: var(--nebensatz); }
.card.c1color { border-color: var(--c1color); }
.card h4 { font-size: 0.55rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--dim); margin-bottom: 8px; }
.formula { font-family: 'EB Garamond', serif; font-size: 1rem; color: var(--text); font-weight: 600; margin-bottom: 6px; }
.rule-text { font-size: 0.7rem; line-height: 1.7; color: var(--dim2); }

/* Sentence display */
.sent-block { margin: 6px 0; }
.sent-de {
  font-family: 'EB Garamond', serif; font-size: 1rem;
  color: var(--text); font-weight: 600; line-height: 1.4;
}
.sent-parts { display: flex; flex-wrap: wrap; gap: 4px; margin: 4px 0; }
.part-chip {
  font-size: 0.55rem; padding: 3px 8px; border-radius: 4px;
  background: var(--s3); border: 1px solid var(--border);
  white-space: nowrap;
}
.sent-ru { font-size: 0.65rem; color: var(--dim); margin-top: 2px; }

/* Table */
.gram-table {
  width: 100%; border-collapse: collapse;
  font-size: 0.65rem; margin: 4px 0;
}
.gram-table th {
  background: var(--s3); color: var(--dim);
  font-size: 0.5rem; letter-spacing: 0.08em; text-transform: uppercase;
  padding: 6px 8px; text-align: left;
  position: sticky; top: 0;
}
.gram-table td { padding: 5px 8px; border-top: 1px solid var(--border); }
.gram-table tr:hover td { background: var(--s3); }
.gram-table .hl { color: var(--gold); font-weight: 500; }
.gram-table .de { font-family: 'EB Garamond', serif; font-size: 0.8rem; color: var(--text); }

/* Make tables scrollable on mobile */
.table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 4px -4px; padding: 0 4px; }

/* Tabs */
.tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; }
.tab {
  padding: 10px 16px; font-size: 0.6rem; letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--dim); cursor: pointer; border-bottom: 2px solid transparent;
  margin-bottom: -1px; transition: all 0.2s; white-space: nowrap;
  flex-shrink: 0;
}
.tab.active { color: var(--text); border-color: var(--gold); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Placeholder */
.ph { text-align: center; padding: 40px 16px; color: var(--dim); }
.ph-icon { font-family: 'EB Garamond', serif; font-size: 3rem; opacity: 0.12; margin-bottom: 16px; }
.ph p { font-size: 0.7rem; line-height: 1.8; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ── Various UI components ── */
.ex-note { font-size: 0.55rem; color: var(--gold); background: rgba(224,196,106,0.1); padding: 1px 6px; border-radius: 3px; margin-left: 6px; }

/* ── EXERCISE INPUT ── */
.ew-inp, .ew-textarea, .ex-inp {
  width: 100%; background: var(--bg); border: 1px solid var(--border);
  color: var(--text); padding: 12px 14px;
  font-family: 'DM Mono', monospace; font-size: 16px; /* prevent iOS zoom */
  border-radius: 6px; outline: none; transition: border-color 0.2s;
}
.ew-inp:focus, .ew-textarea:focus, .ex-inp:focus { border-color: var(--gold); }
.ew-inp.ok, .ex-inp.ok { border-color: var(--present); color: var(--present); }
.ew-inp.bad, .ex-inp.bad { border-color: var(--past); color: var(--past); }

/* ── BUTTONS ── */
.ew-btn-check, .ew-btn-submit, .btn-check {
  padding: 12px 18px; background: var(--gold); color: var(--bg);
  border: none; font-family: 'DM Mono', monospace; font-size: 0.65rem;
  font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase;
  cursor: pointer; border-radius: 6px; transition: opacity 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.ew-btn-check:hover, .ew-btn-submit:hover, .btn-check:hover { opacity: 0.85; }
.ew-btn-next, .ew-btn-skip, .btn-next {
  padding: 12px 16px; background: transparent;
  border: 1px solid var(--border); color: var(--dim);
  font-family: 'DM Mono', monospace; font-size: 0.65rem;
  letter-spacing: 0.1em; text-transform: uppercase;
  cursor: pointer; border-radius: 6px; transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.ew-btn-next:hover, .ew-btn-skip:hover, .btn-next:hover { border-color: var(--dim2); color: var(--text); }

/* ── FEEDBACK ── */
.ew-fb, .ex-fb { margin-top: 8px; font-size: 0.7rem; min-height: 16px; line-height: 1.5; border-radius: 6px; padding: 8px 12px; }
.ew-fb.ok, .ex-fb.ok { color: var(--present); background: rgba(58,217,160,0.08); }
.ew-fb.bad, .ex-fb.bad { color: var(--past); background: rgba(217,79,58,0.08); }

/* ── LEVEL BUTTONS ── */
.lv-btn, .ex-lv-btn, .ew-free-lvbtn, .ew-mode-btn {
  display: flex; align-items: center; gap: 5px;
  padding: 8px 14px; background: transparent;
  border: 1px solid var(--lvc, #888); color: var(--lvc, #888);
  font-family: 'DM Mono', monospace; font-size: 0.6rem;
  font-weight: 500; letter-spacing: 0.08em;
  cursor: pointer; border-radius: 20px; transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
  white-space: nowrap;
}
.lv-btn:hover, .ex-lv-btn:hover { background: color-mix(in srgb, var(--lvc) 15%, transparent); }
.lv-btn.active, .ex-lv-btn.active, .ew-free-lvbtn.active { background: var(--lvc); color: var(--bg); }
.ew-mode-btn { border-radius: 8px; flex: 1; justify-content: center; padding: 10px 8px; }
.ew-mode-btn.active { background: var(--s3); border-color: rgba(255,255,255,0.2); color: var(--text); }

/* ── PROGRESS DOTS ── */
.ew-dots, .ex-dots { display: flex; gap: 4px; margin-bottom: 10px; flex-wrap: wrap; }
.ew-dot, .ex-dot, .ep-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--s3); border: 1px solid var(--border);
  transition: background 0.3s;
}
.ew-dot.ok, .ep-dot.ok { background: var(--present); border-color: var(--present); }
.ew-dot.bad, .ep-dot.bad { background: var(--past); border-color: var(--past); }
.ew-dot.cur, .ep-dot.cur { background: var(--gold); border-color: var(--gold); }

/* ── TASK CARD ── */
.ew-task {
  background: var(--s2); border-radius: 10px; padding: 14px 16px;
  margin-bottom: 12px; border-left: 3px solid var(--lvc, var(--gold));
  animation: fadeUp 0.25s ease;
}
.ew-task-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
.ew-task-lv {
  font-size: 0.5rem; padding: 3px 10px; border-radius: 10px;
  background: var(--lvc, var(--gold)); color: var(--bg); font-weight: 700;
}
.ew-task-type { font-size: 0.5rem; color: var(--dim); background: var(--s3); padding: 2px 8px; border-radius: 10px; }
.ew-task-num { font-size: 0.48rem; color: var(--dim); margin-left: auto; }
.ew-task-instr {
  font-family: 'EB Garamond', serif; font-size: 1.05rem;
  color: var(--text); line-height: 1.5; margin-bottom: 8px;
}
.ew-task-hint {
  font-size: 0.65rem; color: var(--gold); line-height: 1.5;
  background: rgba(224,196,106,0.07); border-radius: 6px;
  padding: 8px 12px; border-left: 2px solid rgba(224,196,106,0.4);
}
.ew-task-words { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
.ew-word-chip {
  font-size: 0.62rem; padding: 5px 12px; border-radius: 14px;
  background: var(--s3); border: 1px solid var(--border);
  color: var(--dim2); font-family: 'EB Garamond', serif;
  cursor: pointer; transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.ew-word-chip:hover { border-color: var(--gold); color: var(--gold); }

/* ── TEXTAREA ── */
.ew-textarea-wrap { position: relative; margin-bottom: 8px; }
.ew-textarea {
  font-family: 'EB Garamond', serif;
  font-size: 1.05rem; line-height: 1.6;
  resize: none; min-height: 80px;
}
.ew-char-count {
  position: absolute; bottom: 8px; right: 11px;
  font-size: 0.5rem; color: var(--dim); pointer-events: none;
}

/* ── BTNS ROW ── */
.ew-btns, .ew-free-btns { display: flex; gap: 8px; margin-bottom: 10px; }
.ew-btn-check, .ew-btn-submit { flex: 2; display: flex; align-items: center; justify-content: center; gap: 6px; }
.ew-btn-next, .ew-btn-skip { flex: 1; }
.ew-btn-submit:disabled { opacity: 0.4; cursor: not-allowed; }

/* ── RESULT BOX ── */
.ew-result {
  border-radius: 10px; padding: 14px 16px; margin-bottom: 12px;
  animation: fadeUp 0.25s ease; position: relative;
}
.ew-result.ok   { background: rgba(58,217,160,0.07); border: 1px solid rgba(58,217,160,0.25); }
.ew-result.warn { background: rgba(224,196,106,0.07); border: 1px solid rgba(224,196,106,0.25); }
.ew-result.bad  { background: rgba(217,79,58,0.07);  border: 1px solid rgba(217,79,58,0.25); }
.ew-result-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.ew-result-icon { font-size: 1.3rem; }
.ew-result-score-lbl { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; }
.ew-result.ok .ew-result-score-lbl   { color: var(--present); }
.ew-result.warn .ew-result-score-lbl { color: var(--gold); }
.ew-result.bad .ew-result-score-lbl  { color: var(--past); }

/* Student sentence with annotations */
.ew-student-sent {
  font-family: 'EB Garamond', serif; font-size: 1rem;
  color: var(--text); line-height: 1.6;
  padding: 8px 12px; background: var(--s3); border-radius: 6px;
  margin-bottom: 10px;
}
.ew-ann-err { text-decoration: underline wavy var(--past); color: var(--past); cursor: help; }
.ew-corrected { margin-bottom: 8px; }
.ew-corrected-label { font-size: 0.48rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--present); opacity: 0.7; margin-bottom: 3px; }

/* Error list */
.ew-errors { margin-bottom: 8px; }
.ew-error-item {
  display: flex; gap: 8px; padding: 5px 0;
  border-bottom: 1px solid var(--border); font-size: 0.65rem; line-height: 1.5;
}
.ew-error-item:last-child { border-bottom: none; }
.ew-err-tag { font-size: 0.48rem; padding: 2px 7px; border-radius: 4px; background: rgba(217,79,58,0.15); color: var(--past); font-weight: 600; white-space: nowrap; height: fit-content; margin-top: 2px; }
.ew-err-text { color: var(--dim2); flex: 1; }
.ew-err-wrong { color: var(--past); font-weight: 600; font-family: 'EB Garamond', serif; }
.ew-err-right { color: var(--present); font-weight: 600; font-family: 'EB Garamond', serif; }
.ew-parts { margin-top: 8px; }
.ew-parts-label { font-size: 0.48rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--dim); margin-bottom: 5px; }
.ew-parts-row { display: flex; gap: 5px; flex-wrap: wrap; }
.ew-part-chip {
  font-size: 0.52rem; padding: 4px 8px; border-radius: 5px;
  background: var(--s3); border: 1px solid var(--border);
  display: flex; gap: 4px; align-items: center;
}
.ew-part-chip .pw { font-family: 'EB Garamond', serif; font-size: 0.65rem; font-weight: 600; color: var(--text); }
.ew-part-chip .pr { color: var(--dim); font-size: 0.46rem; }
.ew-tip {
  font-size: 0.65rem; color: var(--gold); margin-top: 8px;
  padding: 8px 12px; background: rgba(224,196,106,0.06);
  border-radius: 6px; line-height: 1.5;
}

/* Stats bar */
.ew-stats {
  display: flex; gap: 0; border-radius: 10px; overflow: hidden;
  background: var(--s2); margin-bottom: 12px;
}
.ew-stat { flex: 1; text-align: center; padding: 10px 6px; }
.ew-stat + .ew-stat { border-left: 1px solid var(--border); }
.ew-stat-val { font-size: 1rem; font-weight: 700; color: var(--text); }
.ew-stat-val.green { color: var(--present); }
.ew-stat-val.red   { color: var(--past); }
.ew-stat-val.gold  { color: var(--gold); }
.ew-stat-lbl { font-size: 0.46rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--dim); margin-top: 2px; }

/* History */
.ew-history { border-top: 1px solid var(--border); padding-top: 12px; margin-top: 4px; }
.ew-hist-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.ew-hist-title { font-size: 0.5rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--dim); }
.ew-hist-clear { font-size: 0.5rem; color: var(--dim); background: none; border: none; cursor: pointer; padding: 4px; }
.ew-hist-item {
  padding: 10px 12px; border-radius: 8px; margin-bottom: 6px;
  border-left: 3px solid; animation: fadeUp 0.2s ease;
}
.ew-hist-item.ok   { background: rgba(58,217,160,0.05);  border-color: var(--present); }
.ew-hist-item.warn { background: rgba(224,196,106,0.05); border-color: var(--gold); }
.ew-hist-item.bad  { background: rgba(217,79,58,0.05);   border-color: var(--past); }
.ew-hist-sent { font-family: 'EB Garamond', serif; font-size: 0.9rem; font-weight: 600; color: var(--text); margin-bottom: 2px; }
.ew-hist-fb { font-size: 0.6rem; color: var(--dim2); line-height: 1.5; }
.ew-hist-fb em { color: var(--present); font-style: normal; }
.ew-hist-fb s { color: var(--past); text-decoration: line-through; }

/* Empty / no task */
.ew-empty { text-align: center; padding: 28px 20px; color: var(--dim); }
.ew-empty-icon { font-size: 2.5rem; opacity: 0.1; margin-bottom: 10px; font-family: 'EB Garamond', serif; }

/* ── EXAMPLES TAB ── */
.ex-lvl-bar { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
.ex-lv-btn { position: relative; }
.ex-lv-count {
  position: absolute; top: -5px; right: -5px;
  font-size: 0.42rem; background: var(--lvc); color: var(--bg);
  border-radius: 8px; padding: 0 4px;
}
.ex-lv-desc {
  font-size: 0.6rem; color: var(--dim2); line-height: 1.5;
  margin-bottom: 12px; padding: 8px 12px;
  background: var(--s2); border-radius: 6px;
  border-left: 2px solid var(--lvc, var(--gold));
}

/* Example cards */
.ex-main-card {
  background: var(--s2); border-radius: 10px; padding: 16px;
  border: 1px solid var(--border); position: relative; margin-bottom: 10px;
  animation: fadeUp 0.3s ease;
}
.ex-lv-badge { position: absolute; top: 12px; right: 12px; padding: 2px 8px; border-radius: 10px; font-size: 0.5rem; font-weight: 700; color: #000; }
.ex-card-counter { font-size: 0.5rem; color: var(--dim); margin-bottom: 6px; letter-spacing: 0.08em; }
.ex-sent-de { font-size: 1.05rem; font-family: 'EB Garamond', serif; line-height: 1.5; margin-bottom: 6px; color: #eef; }
.ex-sent-ru { font-size: 0.7rem; color: var(--dim2); margin-bottom: 5px; line-height: 1.5; }
.ex-sent-note { font-size: 0.6rem; color: var(--gold); padding: 4px 8px; background: rgba(224,196,106,0.08); border-radius: 4px; margin-top: 4px; }
.ex-note-icon { margin-right: 4px; opacity: 0.6; }
.ex-analysis-toggle { margin-top: 8px; }
.ex-analysis-toggle summary { font-size: 0.6rem; color: var(--dim); cursor: pointer; user-select: none; list-style: none; padding: 4px 0; }
.ex-analysis-toggle summary::-webkit-details-marker { display: none; }
.ex-analysis-toggle summary::before { content: '▾ '; }
.ex-analysis-toggle[open] summary::before { content: '▴ '; }
.ex-analysis-chips { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; }
.ex-chip-wrap { display: flex; flex-direction: column; align-items: center; background: rgba(255,255,255,0.04); border-radius: 5px; padding: 4px 8px; gap: 1px; }
.ex-chip-word { font-size: 0.72rem; color: #dde0f0; }
.ex-chip-role { font-size: 0.44rem; color: var(--gold); letter-spacing: 0.06em; text-transform: uppercase; }

/* Navigation */
.ex-nav-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
.ex-nav-btn {
  flex: 0 0 auto; padding: 8px 14px; background: var(--s3); border: 1px solid var(--border);
  border-radius: 6px; color: var(--dim2); cursor: pointer; font-family: inherit; font-size: 0.62rem;
  transition: all 0.15s; -webkit-tap-highlight-color: transparent;
}
.ex-nav-btn:hover:not(:disabled) { color: #fff; border-color: rgba(255,255,255,0.2); }
.ex-nav-btn:disabled { opacity: 0.3; cursor: default; }
.ex-dots-row { flex: 1; display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; }
.ex-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--s3); border: 1px solid var(--border); transition: all 0.2s; }
.ex-dot.active { background: var(--lvc,#3a8fd9); border-color: var(--lvc,#3a8fd9); width: 18px; border-radius: 4px; }

/* Generate button */
.ex-more-btn {
  display: flex; align-items: center; gap: 8px; width: 100%; padding: 12px 14px;
  background: transparent; border: 1.5px dashed var(--border); border-radius: 8px;
  color: var(--dim2); cursor: pointer; font-family: inherit; font-size: 0.65rem;
  transition: all 0.2s; margin-top: 4px; -webkit-tap-highlight-color: transparent;
}
.ex-more-btn:hover { border-color: rgba(255,255,255,0.25); color: #fff; }
.ex-more-btn.primary { border-color: var(--lvc,#3a8fd9); color: var(--lvc,#3a8fd9); }
.ex-more-pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--lvc,#3a8fd9); animation: pulse 1.4s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(1.3)} }
.ex-load-state { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 30px 10px; }
.ex-load-spinner { width: 28px; height: 28px; border: 2px solid var(--border); border-top-color: var(--lvc,#3a8fd9); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.ex-load-text { font-size: 0.65rem; color: var(--dim2); text-align: center; line-height: 1.6; }
.ex-builtin-label { font-size: 0.5rem; color: var(--dim); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 8px; }
.ex-empty-state { padding: 24px; text-align: center; }
.ex-empty-icon { font-size: 2rem; opacity: 0.15; margin-bottom: 8px; }
.ex-empty-text { font-size: 0.65rem; color: var(--dim2); }
.ex-total-badge { font-size: 0.52rem; color: var(--dim); background: var(--s3); padding: 2px 8px; border-radius: 10px; display: inline-block; margin-bottom: 8px; }

/* AI loading */
.ai-loading {
  display: flex; align-items: center; gap: 10px;
  padding: 16px; color: var(--dim2); font-size: 0.65rem;
  animation: fadeUp 0.3s ease;
}
.ai-spin {
  width: 18px; height: 18px; flex-shrink: 0;
  border: 2px solid var(--border);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* Part chip colors */
.chip-s { color: #3ad9a0; }
.chip-v { color: #e0c46a; }
.chip-o { color: #3a8fd9; }
.chip-a { color: #c97ae0; }
.chip-ad{ color: #d94f3a; }
.chip-p { color: #e08c3a; }
.chip-n { color: #aaa; }

/* ════════════════════════════════════════
   MOBILE RESPONSIVE
   ════════════════════════════════════════ */

@media (max-width: 899px) {
  :root { --wheel-size: min(92vw, 600px); }

  nav {
    padding: 10px 14px;
    gap: 6px;
  }
  .logo { font-size: 1.1rem; }
  .nav-toggle { display: block; }
  .nav-legend {
    display: none;
    width: 100%; order: 10;
    padding-top: 8px; border-top: 1px solid var(--border);
  }
  .nav-legend.open { display: flex; }
  .nav-score { gap: 10px; }
  .ns-n { font-size: 1rem; }

  .layout { flex-direction: column; }

  .wheel-panel {
    padding: 16px 8px 24px;
    min-height: auto;
  }

  .w-center { width: 60px; height: 60px; font-size: 0.45rem; }

  .ip-head { padding: 16px 16px 14px; }
  .ip-title { font-size: 1.5rem; }
  .ip-body { padding: 16px; }

  .card { padding: 12px 14px; }
  .formula { font-size: 0.92rem; }
  .rule-text { font-size: 0.68rem; }

  .gram-table { font-size: 0.6rem; }
  .gram-table th { padding: 5px 6px; font-size: 0.46rem; }
  .gram-table td { padding: 4px 6px; }

  .tab { padding: 8px 12px; font-size: 0.55rem; }

  .ew-task-instr { font-size: 0.95rem; }
  .ew-task-hint { font-size: 0.6rem; padding: 6px 10px; }

  .ew-btns, .ew-free-btns { flex-wrap: wrap; }
  .ew-btn-check, .ew-btn-submit { min-height: 44px; }
  .ew-btn-next, .ew-btn-skip { min-height: 44px; }

  /* Bigger touch targets */
  .lv-btn, .ex-lv-btn, .ew-free-lvbtn { padding: 8px 14px; font-size: 0.58rem; }
  .ew-mode-btn { padding: 10px 8px; font-size: 0.58rem; }
  .ex-nav-btn { padding: 10px 16px; }

  .bc { font-size: 0.55rem; }
  .btn-back { padding: 10px 20px; }
}

@media (max-width: 480px) {
  :root { --wheel-size: 96vw; }
  nav { padding: 8px 10px; }
  .logo { font-size: 1rem; }
  .wheel-panel { padding: 12px 4px 20px; }
  .w-center { width: 50px; height: 50px; font-size: 0.4rem; }
  .ip-head { padding: 14px 12px 12px; }
  .ip-title { font-size: 1.3rem; }
  .ip-body { padding: 12px; }
  .ew-task { padding: 12px; }
  .ex-main-card { padding: 12px; }
}
</style>
</head>
<body>

<nav>
  <div class="logo">Deutsch Rad C1</div>
  <button class="nav-toggle" id="navToggle">Легенда ▾</button>
  <div class="nav-legend" id="navLegend">
    <div class="nl"><div class="nd" style="background:var(--past)"></div>Vergangenheit</div>
    <div class="nl"><div class="nd" style="background:var(--present)"></div>Gegenwart</div>
    <div class="nl"><div class="nd" style="background:var(--future)"></div>Zukunft</div>
    <div class="nl"><div class="nd" style="background:var(--special)"></div>Modus/Nomen</div>
    <div class="nl"><div class="nd" style="background:var(--syntax)"></div>Syntax</div>
    <div class="nl"><div class="nd" style="background:var(--nebensatz)"></div>Nebensatz</div>
    <div class="nl"><div class="nd" style="background:var(--c1color)"></div>C1</div>
  </div>
  <div class="nav-score">
    <div class="ns"><div class="ns-n" id="sc-ok" style="color:var(--present)">0</div><div class="ns-l">верно</div></div>
    <div class="ns"><div class="ns-n" id="sc-bad" style="color:var(--past)">0</div><div class="ns-l">ошибок</div></div>
  </div>
</nav>

<div class="layout">
  <div class="wheel-panel">
    <div class="wheel-wrap" id="wheelWrap">
      <canvas id="wc"></canvas>
      <div class="w-center" id="wCenter">Deutsch<br>Rad</div>
    </div>
    <div class="bc" id="bc"></div>
    <button class="btn-back" id="btnBack" style="display:none">← Назад</button>
  </div>

  <div class="info-panel">
    <div class="ip-head">
      <div class="ip-tag" id="ipTag">Нажмите на сегмент · <span style="color:var(--c1color)">C1 Niveau</span></div>
      <div class="ip-title" id="ipTitle">Deutsch Rad C1</div>
      <div class="ip-sub" id="ipSub">Полный курс немецкого от A1 до C1 — все темы, все структуры</div>
    </div>
    <div class="ip-body" id="ipBody">
      <div class="ph">
        <div class="ph-icon">⊙</div>
        <p>
          Кликните любой сегмент колеса — он фрактально раскрывается.<br><br>
          <b style="color:var(--past)">Красное</b> — Vergangenheit<br>
          <b style="color:var(--future)">Синее</b> — Futur I + II<br>
          <b style="color:var(--present)">Зелёное</b> — Präsens, Verblehre<br>
          <b style="color:var(--special)">Фиолетовое</b> — Konjunktiv, Nomen<br>
          <b style="color:var(--syntax)">Оранжевое</b> — Satzbau, Syntax<br>
          <b style="color:var(--nebensatz)">Бирюзовое</b> — Nebensätze<br>
          <b style="color:var(--c1color)">Розовое</b> — C1-Strukturen<br><br>
          Каждый узел: <em>правило · таблица · примеры · упражнения</em>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════
// NAV TOGGLE
// ═══════════════════════════════════════════════════════════════════
document.getElementById('navToggle').addEventListener('click', function() {
  const leg = document.getElementById('navLegend');
  leg.classList.toggle('open');
  this.textContent = leg.classList.contains('open') ? 'Легенда ▴' : 'Легенда ▾';
});

// ═══════════════════════════════════════════════════════════════════
// DATA LAYER (same as original - abbreviated variable names)
// ═══════════════════════════════════════════════════════════════════
const Z={PAST:'past',PRESENT:'present',FUTURE:'future',SPECIAL:'special',SYNTAX:'syntax',NEB:'nebensatz',C1:'c1color'};

const ROOT_SEGS=[
  {id:'prasens',label:'Präsens',sub:'Настоящее',color:'#3ad9a0',zone:Z.PRESENT},
  {id:'futur1',label:'Futur I+II',sub:'Будущее',color:'#3a8fd9',zone:Z.FUTURE},
  {id:'perfekt',label:'Perfekt',sub:'Прошедшее',color:'#d94f3a',zone:Z.PAST},
  {id:'prateritum',label:'Präteritum',sub:'Нарратив',color:'#b03020',zone:Z.PAST},
  {id:'plusquamp',label:'Plusquamperf.',sub:'Давнопрошедшее',color:'#7a1a10',zone:Z.PAST},
  {id:'konjunktiv',label:'Konjunktiv',sub:'Сослагательное',color:'#c97ae0',zone:Z.SPECIAL},
  {id:'imperativ',label:'Imperativ',sub:'Повелительное',color:'#e08c3a',zone:Z.SPECIAL},
  {id:'satzbau',label:'Satzbau',sub:'Синтаксис',color:'#e07a40',zone:Z.SYNTAX},
  {id:'verblehre',label:'Verblehre',sub:'Глаголы',color:'#e0c46a',zone:Z.PRESENT},
  {id:'nomenlehre',label:'Nomen+Adj.',sub:'Сущ. и прилаг.',color:'#c97ae0',zone:Z.SPECIAL},
  {id:'nebensatz',label:'Nebensätze',sub:'Придаточные',color:'#4ae0c0',zone:Z.NEB},
  {id:'c1strukt',label:'C1-Strukt.',sub:'Уровень C1',color:'#ff6090',zone:Z.C1},
];

const CHILDREN={prasens:[{id:'pra_aussage',label:'Aussagesatz',sub:'Утвердительное'},{id:'pra_frage_j',label:'Ja/Nein-Frage',sub:'Общий вопрос'},{id:'pra_frage_w',label:'W-Frage',sub:'Специальный'},{id:'pra_neg',label:'Negation',sub:'Отрицание'},{id:'pra_verb',label:'Verb',sub:'Спряжение'},{id:'pra_nomen',label:'Nomen',sub:'Падежи'},{id:'pra_adj',label:'Adjektiv',sub:'Склонение'},{id:'pra_prap',label:'Präposition',sub:'Предлоги'}],futur1:[{id:'fut1_aussage',label:'Futur I',sub:'Утвердительное'},{id:'fut1_frage',label:'Frage',sub:'Вопрос'},{id:'fut1_neg',label:'Negation F1',sub:'Отрицание'},{id:'fut1_werden',label:'werden',sub:'Спряжение'},{id:'fut2_aussage',label:'Futur II',sub:'Утвердительное'},{id:'fut2_neg',label:'Negation F2',sub:'Отрицание FII'}],perfekt:[{id:'pf_aussage',label:'Aussagesatz',sub:'Утвердительное'},{id:'pf_frage',label:'Frage',sub:'Вопрос'},{id:'pf_neg',label:'Negation',sub:'Отрицание'},{id:'pf_haben',label:'haben',sub:'haben-Verben'},{id:'pf_sein',label:'sein',sub:'sein-Verben'},{id:'pf_part2',label:'Partizip II',sub:'Образование'}],prateritum:[{id:'prat_aussage',label:'Aussagesatz',sub:'Утвердительное'},{id:'prat_frage',label:'Frage',sub:'Вопрос'},{id:'prat_neg',label:'Negation',sub:'Отрицание'},{id:'prat_schwach',label:'Schwache V.',sub:'Слабые'},{id:'prat_stark',label:'Starke V.',sub:'Сильные'},{id:'prat_modal',label:'Modalverben',sub:'Модальные'}],plusquamp:[{id:'plq_aussage',label:'Aussagesatz',sub:'Утвердительное'},{id:'plq_neg',label:'Negation',sub:'Отрицание'}],konjunktiv:[{id:'konj2',label:'Konj. II',sub:'Нереальное'},{id:'konj2_wurd',label:'würde+Inf',sub:'Описательная'},{id:'konj1',label:'Konj. I',sub:'Косв. речь'},{id:'konj_irrealis',label:'Irrealis',sub:'Условие'}],imperativ:[{id:'imp_du',label:'du-Form',sub:'Ты'},{id:'imp_ihr',label:'ihr-Form',sub:'Вы (мн.)'},{id:'imp_sie',label:'Sie-Form',sub:'Вы (вежл.)'},{id:'imp_neg',label:'Negation',sub:'Запрет'}],pra_aussage:[{id:'pra_aus_wort',label:'Wortstellung',sub:'Порядок слов'},{id:'pra_aus_subj',label:'Subjekt',sub:'Подлежащее'},{id:'pra_aus_verb',label:'Verb (Pos.2)',sub:'Глагол'},{id:'pra_aus_obj_a',label:'Akk.-Objekt',sub:'Вин. падеж'},{id:'pra_aus_obj_d',label:'Dat.-Objekt',sub:'Дат. падеж'},{id:'pra_aus_adv',label:'Adverb',sub:'Обстоятельство'}],pra_verb:[{id:'verb_schwach',label:'Schwache V.',sub:'Слабые'},{id:'verb_stark',label:'Starke V.',sub:'Сильные'},{id:'verb_modal',label:'Modalverben',sub:'Модальные'},{id:'verb_trenn',label:'Trennbare V.',sub:'Отделяемые'},{id:'verb_refl',label:'Reflexive V.',sub:'Возвратные'}],pra_nomen:[{id:'nom_genus',label:'Genus',sub:'Род'},{id:'nom_plural',label:'Plural',sub:'Мн. число'},{id:'nom_kasus',label:'4 Kasus',sub:'Все падежи'},{id:'nom_gen',label:'Genitiv',sub:'Родит. падеж'}],satzbau:[{id:'sb_v2',label:'V2-Prinzip',sub:'Глагол на P2'},{id:'sb_klammer',label:'Satzklammer',sub:'Рамка'},{id:'sb_mittelfeld',label:'Mittelfeld',sub:'Серед. поле'},{id:'sb_tekamolo',label:'TeKaMoLo',sub:'Порядок обст.'},{id:'sb_inversion',label:'Inversion',sub:'Инверсия'},{id:'sb_fragesatz',label:'Fragesätze',sub:'Вопросы'},{id:'sb_negation',label:'Negation',sub:'Отрицание'},{id:'sb_valenz',label:'Valenz',sub:'Управление'}],verblehre:[{id:'vl_schwach',label:'Schwache V.',sub:'Слабые'},{id:'vl_stark',label:'Starke V.',sub:'Сильные'},{id:'vl_modal',label:'Modalverben',sub:'Модальные'},{id:'vl_trenn',label:'Trennbare',sub:'Отделяемые'},{id:'vl_refl',label:'Reflexive',sub:'Возвратные'},{id:'vl_untrenn',label:'Untrennbare',sub:'Неотделяемые'},{id:'vl_passiv',label:'Passiv',sub:'Страд. залог'},{id:'vl_praepobj',label:'Präp.Objekte',sub:'Управление'}],nomenlehre:[{id:'nl_genus',label:'Genus',sub:'Род'},{id:'nl_plural',label:'Plural',sub:'Мн. число'},{id:'nl_kasus4',label:'4 Kasus',sub:'Падежи'},{id:'nl_adj_dekl',label:'Adj.Deklination',sub:'Прилаг.'},{id:'nl_adj_komp',label:'Komparation',sub:'Степени'},{id:'nl_pronomen',label:'Pronomen',sub:'Местоимения'},{id:'nl_praep',label:'Präpositionen',sub:'Предлоги'},{id:'nl_nominalis',label:'Nominalisierung',sub:'Номинализ.'}],nebensatz:[{id:'ns_dass',label:'dass-Satz',sub:'что...'},{id:'ns_weil',label:'weil / da',sub:'потому что'},{id:'ns_wenn_als',label:'wenn / als',sub:'когда'},{id:'ns_ob',label:'ob-Satz',sub:'ли...'},{id:'ns_relativ',label:'Relativsatz',sub:'Относит.'},{id:'ns_infinitiv',label:'Infinitivsatz',sub:'um/ohne/statt zu'},{id:'ns_konzessiv',label:'obwohl/trotzdem',sub:'Уступит.'},{id:'ns_temporal',label:'Temporalsatz',sub:'Временные'},{id:'ns_konditional',label:'wenn/falls',sub:'Условные'},{id:'ns_kausal',label:'Kausalsatz',sub:'Причинные'},{id:'ns_konsekutiv',label:'sodass',sub:'Следственные'},{id:'ns_final',label:'damit/um zu',sub:'Целевые'}],c1strukt:[{id:'c1_partizip',label:'Partizipialsatz',sub:'Прич. оборот'},{id:'c1_erw_adj',label:'Erw.Adj.Attr.',sub:'Расш. опред.'},{id:'c1_fvg',label:'Funktionsverbgef.',sub:'ФГС'},{id:'c1_doppelkonj',label:'Doppelkonjunkt.',sub:'Двойн. союзы'},{id:'c1_passiv_adv',label:'Passiv-Ersatz',sub:'Замены пасс.'},{id:'c1_konj2',label:'Konjunktiv II',sub:'Сослагат.'},{id:'c1_konj1',label:'Konjunktiv I',sub:'Косв. речь'},{id:'c1_modalsubj',label:'Subj.Modalität',sub:'Субъ. модаль.'},{id:'c1_stil',label:'Stilmittel',sub:'Стилистика'}],pf_haben:[{id:'pf_haben_trans',label:'Transitiv',sub:'Переходные'},{id:'pf_haben_refl',label:'Reflexiv',sub:'Возвратные'},{id:'pf_haben_modal',label:'Modalverben',sub:'Модальные'}],vl_modal:[{id:'vm_bedeutung',label:'Bedeutungen',sub:'Значения'},{id:'vm_praesens',label:'Präsens/Prät.',sub:'Спряжение'},{id:'vm_konjunktiv',label:'Konj.II',sub:'Сослагат.'},{id:'vm_subjektiv',label:'Subj.Gebrauch',sub:'Субъ. употр.'}],vl_passiv:[{id:'pas_vorgang',label:'Vorgangspassiv',sub:'werden-Pass.'},{id:'pas_zustand',label:'Zustandspassiv',sub:'sein-Pass.'},{id:'pas_modal',label:'Passiv+Modal',sub:'С модальными'},{id:'pas_zeiten',label:'Alle Zeiten',sub:'Все времена'}],nl_adj_dekl:[{id:'adj_schwach',label:'Schwach',sub:'После def.Art.'},{id:'adj_stark',label:'Stark',sub:'Без артикля'},{id:'adj_gemischt',label:'Gemischt',sub:'После indef.'},{id:'adj_praedik',label:'Prädikativ',sub:'Сказуемостн.'}],nl_praep:[{id:'pr_akk_dat',label:'Akk+Dat Präp.',sub:'Akk/Dat'},{id:'pr_wechsel',label:'Wechselpräp.',sub:'2 падежа'},{id:'pr_gen_praep',label:'Gen.-Präp.',sub:'Родит. падеж'},{id:'pr_temporal',label:'Temporale P.',sub:'Время'}],ns_relativ:[{id:'rel_nom_akk',label:'Nom./Akk.',sub:'der/den...'},{id:'rel_dat_gen',label:'Dat./Gen.',sub:'dem/dessen...'},{id:'rel_praep',label:'mit Präp.',sub:'mit dem...'},{id:'rel_wo',label:'wo/worüber',sub:'Локальн.'}],c1_konj2:[{id:'k2_formen',label:'Formen',sub:'Bildung'},{id:'k2_irrealis',label:'Irrealis',sub:'Нереальн.'},{id:'k2_hoeflich',label:'Höflichkeit',sub:'Вежливость'},{id:'k2_vergangen',label:'Vergangenheit',sub:'Прошедшее'}]};

// ═══════════════════════════════════════════════════════════════════
// CONTENT (using the full CONTENT object from the original)
// ═══════════════════════════════════════════════════════════════════
const CONTENT={};
const ex=(q,a,h)=>({q,a,h});
const sent=(de,parts,ru)=>({de,parts,ru});

// Minimal content for key sections (keeping same structure as original)
// NOTE: This references the same CONTENT object populated in original code.
// For brevity, I'll include the essential entries. The full data stays the same.

CONTENT['prasens']={zone:'present',tag:'Zeitform',title:'Präsens',sub:'Настоящее время — все уровни',tabs:['Правило','Примеры','Упражнения'],rule:{formula:'Subjekt + Verb₂ + (Objekt) + (Adverb/Präp.)',text:'Präsens — базовое время немецкого. Глагол всегда на <strong>2-й позиции</strong> (V2-правило).<br><br>Спряжение: <em>ich -e / du -st / er -t / wir -en / ihr -t / sie -en</em>.',table:{head:['Person','Endung','lernen','fahren','lesen'],rows:[['ich','-e','lerne','fahre','lese'],['du','-st','lernst','fährst','liest'],['er/sie','-t','lernt','fährt','liest'],['wir','-en','lernen','fahren','lesen'],['ihr','-t','lernt','fahrt','lest'],['sie/Sie','-en','lernen','fahren','lesen']]}},examples:[sent('Ich lerne jeden Tag Deutsch.',[{w:'Ich',r:'S'},{w:'lerne',r:'V'},{w:'jeden Tag',r:'Adv'},{w:'Deutsch',r:'Oa'}],'Я каждый день учу немецкий.'),sent('Er fährt morgen nach Berlin.',[{w:'Er',r:'S'},{w:'fährt',r:'V'},{w:'morgen',r:'Adv'},{w:'nach Berlin',r:'Oa'}],'Он едет завтра в Берлин.')],exercises:[ex('Ich ___ (lernen) jeden Tag.','lerne','ich → -e'),ex('Er ___ (fahren) nach München.','fährt','fahren: a→ä'),ex('Du ___ (lesen) ein Buch.','liest','lesen: e→ie'),ex('Wir ___ (arbeiten) viel.','arbeiten','wir → основа'),ex('Ihr ___ (spielen) Fußball.','spielt','ihr → -t')]};

// Add more content entries as needed - they follow the same pattern
// For now, provide a fallback for missing content
function getContent(id) {
  if (CONTENT[id]) return CONTENT[id];
  // Try to find parent info
  const parent = findParent(id);
  if (parent) {
    return {
      zone: parent.zone || 'present',
      tag: 'Thema',
      title: getChildLabel(id) || id,
      sub: getChildSub(id) || '',
      tabs: ['Правило','Примеры','Упражнения'],
      rule: { formula: getChildLabel(id) || id, text: 'Выберите подраздел для подробной информации.' },
      examples: [],
      exercises: [ex('Dieser Bereich wird bald ergänzt.','—','')]
    };
  }
  return null;
}

function getChildLabel(id) {
  for (const key in CHILDREN) {
    const ch = CHILDREN[key].find(c => c.id === id);
    if (ch) return ch.label;
  }
  return null;
}
function getChildSub(id) {
  for (const key in CHILDREN) {
    const ch = CHILDREN[key].find(c => c.id === id);
    if (ch) return ch.sub;
  }
  return null;
}

// ═══════════════════════════════════════════════════════════════════
// WHEEL ENGINE — responsive canvas
// ═══════════════════════════════════════════════════════════════════

const canvas = document.getElementById('wc');
const ctx = canvas.getContext('2d');

let WHEEL_PX = 600;
let CX, CY, R_OUT, R_IN;
let dpr = window.devicePixelRatio || 1;

function resizeCanvas() {
  const wrap = document.getElementById('wheelWrap');
  const sz = wrap.clientWidth;
  WHEEL_PX = sz;
  canvas.width = sz * dpr;
  canvas.height = sz * dpr;
  canvas.style.width = sz + 'px';
  canvas.style.height = sz + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  CX = sz / 2;
  CY = sz / 2;
  R_OUT = sz / 2 - 6;
  R_IN = Math.max(sz * 0.075, 28);
  drawWheel();
}

let state = {
  level: 'root', path: [], selected: null, hover: null,
  score: {ok:0,bad:0}, exIdx: 0, answered: false, exResults: [],
  activeTab: 0, exLevel: 'B1', exMode: 'free',
  exLoading: false, freeLoading: false, freeTask: null, freeHistory: [],
  _freeInputVal: '', freeStats: {ok:0,warn:0,bad:0}, freeStreaks: {},
  freeTaskNum: 0, exViewIdx: 0,
};

function getSegs() {
  if (state.level === 'root') return ROOT_SEGS.map((s,i,arr)=>({
    ...s, sa:(i/arr.length)*Math.PI*2-Math.PI/2, ea:((i+1)/arr.length)*Math.PI*2-Math.PI/2,
  }));
  const ch = CHILDREN[state.level];
  if (!ch) return [];
  const parent = findParent(state.level);
  const baseColor = parent ? parent.color : '#888';
  return ch.map((s,i)=>({
    ...s, color: shiftColor(baseColor, i, ch.length),
    zone: parent ? parent.zone : 'present',
    sa:(i/ch.length)*Math.PI*2-Math.PI/2, ea:((i+1)/ch.length)*Math.PI*2-Math.PI/2,
  }));
}

function findParent(id) {
  if (id === 'root') return null;
  const rootMatch = ROOT_SEGS.find(r=>r.id===id);
  if (rootMatch) return rootMatch;
  for (const r of ROOT_SEGS) {
    if ((CHILDREN[r.id]||[]).some(c=>c.id===id)) return r;
    for (const c of (CHILDREN[r.id]||[])) {
      if ((CHILDREN[c.id]||[]).some(cc=>cc.id===id)) return c;
    }
  }
  return null;
}

function shiftColor(hex, i, n) {
  const t = n<=1 ? 0.7 : 0.55 + 0.45*(i/(n-1));
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  const h2=(v)=>Math.max(20,Math.min(255,Math.round(v*t))).toString(16).padStart(2,'0');
  return `#${h2(r)}${h2(g)}${h2(b)}`;
}

function drawWheel() {
  ctx.clearRect(0,0,WHEEL_PX,WHEEL_PX);
  for (let r=R_OUT; r>R_IN; r-=Math.max(25, WHEEL_PX*0.06)) {
    ctx.beginPath(); ctx.arc(CX,CY,r,0,Math.PI*2);
    ctx.strokeStyle='rgba(255,255,255,0.03)'; ctx.lineWidth=1; ctx.stroke();
  }
  const segs=getSegs();
  const fontSize = Math.max(10, WHEEL_PX * 0.02);
  const subFontSize = Math.max(8, WHEEL_PX * 0.016);

  segs.forEach(s=>{
    const hover=s.id===state.hover, sel=s.id===state.selected;
    const gap=0.012, r=R_OUT-3;
    ctx.save();
    ctx.beginPath(); ctx.moveTo(CX,CY);
    ctx.arc(CX,CY,r,s.sa+gap,s.ea-gap); ctx.closePath();
    const mid=(s.sa+s.ea)/2;
    const g=ctx.createLinearGradient(CX+R_IN*Math.cos(mid),CY+R_IN*Math.sin(mid),CX+r*Math.cos(mid),CY+r*Math.sin(mid));
    const a1=sel?'28':hover?'18':'0e', a2=sel?'50':hover?'30':'18';
    g.addColorStop(0,s.color+a1); g.addColorStop(1,s.color+a2);
    ctx.fillStyle=g; ctx.fill();
    ctx.strokeStyle=sel?s.color:hover?s.color+'aa':s.color+'55';
    ctx.lineWidth=sel?2:1; ctx.stroke(); ctx.restore();

    const tr=(R_IN+r)*0.5;
    const tx=CX+tr*Math.cos(mid), ty=CY+tr*Math.sin(mid);
    ctx.save(); ctx.translate(tx,ty);
    let rot=mid;
    if (rot>Math.PI/2&&rot<Math.PI*1.5) rot+=Math.PI;
    ctx.rotate(rot);
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`500 ${fontSize}px 'DM Mono'`;
    ctx.fillStyle=sel||hover?'#fff':s.color+'dd';
    ctx.fillText(s.label,0,-fontSize*0.6);
    ctx.font=`${subFontSize}px 'DM Mono'`;
    ctx.fillStyle=sel?'#fff9':'#ffffff44';
    ctx.fillText(s.sub,0,subFontSize*0.7);
    if (CHILDREN[s.id]) {
      ctx.font=`${subFontSize}px DM Mono`; ctx.fillStyle=s.color+'77';
      ctx.fillText('▾',0,subFontSize*2);
    }
    ctx.restore();
  });
  ctx.beginPath(); ctx.arc(CX,CY,R_IN+2,0,Math.PI*2);
  ctx.strokeStyle='rgba(255,255,255,0.08)'; ctx.lineWidth=1; ctx.stroke();
}

function hitTest(x,y) {
  const dx=x-CX, dy=y-CY;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if (dist<R_IN+2||dist>R_OUT) return null;
  let a=Math.atan2(dy,dx);
  if (a<-Math.PI/2) a+=Math.PI*2;
  const segs=getSegs();
  for (const s of segs) {
    let sa=s.sa, ea=s.ea;
    if (sa<-Math.PI/2){sa+=Math.PI*2;ea+=Math.PI*2;}
    if (a>=sa&&a<=ea) return s;
  }
  return null;
}

function getCanvasXY(e) {
  const r=canvas.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  return {
    x: (clientX - r.left) * (WHEEL_PX / r.width),
    y: (clientY - r.top) * (WHEEL_PX / r.height)
  };
}

canvas.addEventListener('mousemove',e=>{
  const {x,y}=getCanvasXY(e);
  const s=hitTest(x,y);
  const nid=s?s.id:null;
  if (nid!==state.hover){state.hover=nid;drawWheel();}
  canvas.style.cursor=s?'pointer':'default';
});
canvas.addEventListener('mouseleave',()=>{state.hover=null;drawWheel();});
canvas.addEventListener('click',e=>{
  const {x,y}=getCanvasXY(e);
  const s=hitTest(x,y);
  if (s) clickSeg(s);
});

// Touch support
let touchStartSeg = null;
canvas.addEventListener('touchstart',e=>{
  const {x,y}=getCanvasXY(e);
  touchStartSeg=hitTest(x,y);
  if (touchStartSeg) {
    state.hover=touchStartSeg.id;
    drawWheel();
  }
},{passive:true});
canvas.addEventListener('touchend',e=>{
  if (touchStartSeg) {
    clickSeg(touchStartSeg);
    touchStartSeg=null;
    state.hover=null;
    drawWheel();
  }
});

function clickSeg(s) {
  state.selected=s.id;
  if (CHILDREN[s.id]) {
    state.path.push({id:s.id,label:s.label,prevLevel:state.level});
    state.level=s.id; state.selected=null;
    updateCenter(s.label);
  }
  renderContent(s.id);
  updateBreadcrumb();
  drawWheel();
  // On mobile, scroll to info panel
  if (window.innerWidth < 900) {
    setTimeout(() => {
      document.querySelector('.info-panel').scrollIntoView({behavior:'smooth',block:'start'});
    }, 100);
  }
}

function updateCenter(label) {
  const el=document.getElementById('wCenter');
  el.innerHTML=label.length>10?label.slice(0,9)+'…':label;
  el.style.fontSize='0.5rem';
}

document.getElementById('btnBack').addEventListener('click',goBack);
function goBack() {
  if (!state.path.length) return;
  const prev=state.path.pop();
  state.level=prev.prevLevel; state.selected=prev.id;
  updateCenter(state.path.length?state.path[state.path.length-1].label:'Deutsch\nRad');
  if (!state.path.length) {
    document.getElementById('wCenter').innerHTML='Deutsch<br>Rad';
    document.getElementById('wCenter').style.fontSize='';
  }
  updateBreadcrumb(); drawWheel();
  renderContent(prev.id);
}

function updateBreadcrumb() {
  const bc=document.getElementById('bc'), back=document.getElementById('btnBack');
  if (!state.path.length){bc.innerHTML='';back.style.display='none';return;}
  back.style.display='';
  let html=`<span class="bc-item" onclick="resetWheel()">⊙</span>`;
  state.path.forEach((p,i)=>{
    html+=`<span class="bc-sep">›</span><span class="bc-item" onclick="navTo(${i})">${p.label}</span>`;
  });
  bc.innerHTML=html;
}

window.resetWheel=function(){
  state.level='root'; state.path=[]; state.selected=null;
  document.getElementById('wCenter').innerHTML='Deutsch<br>Rad';
  document.getElementById('wCenter').style.fontSize='';
  document.getElementById('btnBack').style.display='none';
  document.getElementById('bc').innerHTML='';
  drawWheel(); showPlaceholder();
};
window.navTo=function(idx){
  const p=state.path[idx];
  state.path=state.path.slice(0,idx+1);
  state.level=p.id; state.selected=null;
  updateCenter(p.label); updateBreadcrumb(); drawWheel();
};

// ═══════════════════════════════════════════════════════════════════
// CONTENT RENDERING
// ═══════════════════════════════════════════════════════════════════

function showPlaceholder() {
  document.getElementById('ipTag').innerHTML='Нажмите на сегмент · <span style="color:var(--c1color)">C1</span>';
  document.getElementById('ipTitle').textContent='Deutsch Rad C1';
  document.getElementById('ipTitle').style.color='';
  document.getElementById('ipSub').textContent='Полный курс немецкого от A1 до C1';
  document.getElementById('ipBody').innerHTML=`<div class="ph"><div class="ph-icon">⊙</div>
    <p>Кликните сегмент колеса — он раскроется фрактально.<br><br>
    Каждый узел: <em>правило · таблица · примеры · упражнения</em></p></div>`;
}

function getZoneColor(zone) {
  return {past:'var(--past)',present:'var(--present)',future:'var(--future)',special:'var(--special)',syntax:'var(--syntax)',nebensatz:'var(--nebensatz)',c1color:'var(--c1color)'}[zone]||'var(--gold)';
}

function renderContent(id) {
  const c = getContent(id);
  if (!c) { showPlaceholder(); return; }
  state.activeTab=0; state.exIdx=0; state.answered=false; state.exResults=[];
  state.freeResult=null;

  document.getElementById('ipTag').textContent=c.tag;
  document.getElementById('ipTitle').textContent=c.title;
  document.getElementById('ipTitle').style.color=getZoneColor(c.zone);
  document.getElementById('ipSub').textContent=c.sub;

  let html='<div>';
  html+=`<div class="tabs">${(c.tabs||['Правило']).map((t,i)=>
    `<div class="tab${i===0?' active':''}" data-tab="${i}">${t}</div>`).join('')}</div>`;
  (c.tabs||['Правило']).forEach((t,i)=>{
    html+=`<div class="tab-content${i===0?' active':''}" id="tc-${i}">`;
    if (t==='Правило') html+=renderRuleTab(c);
    else if (t==='Примеры') html+=renderExamplesTab(c);
    else if (t==='Упражнения') html+=renderExerciseTab(c,0);
    html+='</div>';
  });
  html+='</div>';
  document.getElementById('ipBody').innerHTML=html;

  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      const idx=+tab.dataset.tab;
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tc-'+idx).classList.add('active');
      state.activeTab=idx;
      const tabName=c.tabs[idx];
      if (tabName==='Упражнения') {
        document.getElementById('tc-'+idx).innerHTML=renderExerciseTab(c,state.exIdx);
        bindExEvents(c);
        if (!state.freeTask && state.exMode==='free') generateFreeTask(c,state.freeLevel||'B1');
      } else if (tabName==='Примеры') {
        document.getElementById('tc-'+idx).innerHTML=renderExamplesTab(c);
        bindExamplesEvents(c);
      }
    });
  });
  bindExEvents(c);
  bindExamplesEvents(c);
}

function renderRuleTab(c) {
  const r=c.rule;
  if (!r) return '<p style="color:var(--dim);font-size:0.7rem">Нет данных.</p>';
  let h=`<div class="card ${c.zone}"><h4>Формула</h4>
    <div class="formula">${r.formula.replace(/\n/g,'<br>')}</div>
    <div class="rule-text">${r.text||''}</div></div>`;
  if (r.table) {
    h+=`<div class="card gold"><h4>Таблица</h4><div class="table-scroll"><table class="gram-table">
      <thead><tr>${r.table.head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
      <tbody>${r.table.rows.map(row=>`<tr>${row.map((cell,i)=>
        `<td class="${i===0?'hl':'de'}">${cell}</td>`).join('')}</tr>`).join('')}</tbody>
    </table></div></div>`;
  }
  return h;
}

// ═══════════════════════════════════════════════════════════════════
// AI ENGINE
// ═══════════════════════════════════════════════════════════════════

async function callClaude(systemPrompt, userMessage, maxTokens=800) {
  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      model:'claude-sonnet-4-20250514', max_tokens:maxTokens,
      system:systemPrompt, messages:[{role:'user',content:userMessage}]
    })
  });
  const data = await resp.json();
  return data.content?.map(b=>b.text||'').join('') || '';
}

// ═══════════════════════════════════════════════════════════════════
// EXAMPLES TAB
// ═══════════════════════════════════════════════════════════════════

const LEVELS=['A1','A2','B1','B2','C1'];
const LEVEL_COLORS={A1:'#3ad9a0',A2:'#22b87a',B1:'#3a8fd9',B2:'#c97ae0',C1:'#ff6090'};
const LEVEL_DESC={A1:'Базовый — S+V+O',A2:'Простые предложения',B1:'Средний — придаточные',B2:'Сложные конструкции',C1:'Академический стиль'};
const exCache={};

function renderExamplesTab(c) {
  const id=state.selected;
  if (!exCache[id]) exCache[id]={};
  const cur=state.exLevel||'B1';
  const cached=exCache[id][cur]||[];
  const idx=Math.min(state.exViewIdx||0, Math.max(0,cached.length-1));

  const lvBtns=LEVELS.map(lv=>{
    const cnt=exCache[id]?.[lv]?.length||0;
    return `<button class="ex-lv-btn${lv===cur?' active':''}" data-lv="${lv}" style="--lvc:${LEVEL_COLORS[lv]}">${lv}${cnt?`<span class="ex-lv-count">${cnt}</span>`:''}</button>`;
  }).join('');

  let bodyHtml='';
  if (state.exLoading) {
    bodyHtml=`<div class="ex-load-state"><div class="ex-load-spinner" style="border-top-color:${LEVEL_COLORS[cur]}"></div><div class="ex-load-text">Генерирую примеры <strong style="color:${LEVEL_COLORS[cur]}">${cur}</strong>…</div></div>`;
  } else if (cached.length) {
    const ex=cached[idx];
    const chips=(ex.parts||[]).map(p=>`<div class="ex-chip-wrap"><span class="ex-chip-word">${p.w||''}</span><span class="ex-chip-role">${p.r||''}</span></div>`).join('');
    const dots=cached.map((_,i)=>`<div class="ex-dot${i===idx?' active':''}" style="${i===idx?'--lvc:'+LEVEL_COLORS[cur]:''}"></div>`).join('');
    bodyHtml=`<div class="ex-main-card"><div class="ex-lv-badge" style="background:${LEVEL_COLORS[cur]}">${cur}</div>
      <div class="ex-card-counter">${idx+1} / ${cached.length}</div>
      <div class="ex-sent-de">${ex.de||''}</div>
      <div class="ex-sent-ru">${ex.ru||''}</div>
      ${ex.note?`<div class="ex-sent-note"><span class="ex-note-icon">§</span>${ex.note}</div>`:''}
      ${chips?`<details class="ex-analysis-toggle"><summary>Разбор</summary><div class="ex-analysis-chips">${chips}</div></details>`:''}
    </div>
    <div class="ex-nav-row"><button class="ex-nav-btn" id="exPrev" ${idx===0?'disabled':''}>←</button><div class="ex-dots-row">${dots}</div><button class="ex-nav-btn" id="exNext" ${idx>=cached.length-1?'disabled':''}>→</button></div>
    <button class="ex-more-btn" id="btnMoreEx" style="--lvc:${LEVEL_COLORS[cur]}"><span class="ex-more-pulse" style="background:${LEVEL_COLORS[cur]}"></span>Ещё 5 примеров ${cur}</button>`;
  } else {
    // Show builtin
    const builtin=(c.examples||[]).filter(e=>e&&e.de);
    if (builtin.length) {
      const ex0=builtin[0];
      const chips0=(ex0.parts||[]).map(p=>`<div class="ex-chip-wrap"><span class="ex-chip-word">${p.w}</span><span class="ex-chip-role">${p.r}</span></div>`).join('');
      bodyHtml=`<div class="ex-builtin-label">Встроенные примеры</div>
        <div class="ex-main-card" id="builtinCard"><div class="ex-card-counter" id="builtinCounter">1 / ${builtin.length}</div>
        <div class="ex-sent-de" id="builtinDe">${ex0.de}</div>
        <div class="ex-sent-ru" id="builtinRu">${ex0.ru}</div>
        ${chips0?`<details class="ex-analysis-toggle"><summary>Разбор</summary><div class="ex-analysis-chips" id="builtinChips">${chips0}</div></details>`:''}
        </div>
        <div class="ex-nav-row"><button class="ex-nav-btn" id="exPrevB" ${builtin.length<=1?'disabled':''}>←</button><div class="ex-dots-row" id="builtinDots">${builtin.map((_,i)=>`<div class="ex-dot${i===0?' active':''}"></div>`).join('')}</div><button class="ex-nav-btn" id="exNextB" ${builtin.length<=1?'disabled':''}>→</button></div>`;
      state._builtin=builtin; state._builtinIdx=0;
    } else {
      bodyHtml=`<div class="ex-empty-state"><div class="ex-empty-icon">§</div><div class="ex-empty-text">${LEVEL_DESC[cur]}</div></div>`;
    }
    bodyHtml+=`<button class="ex-more-btn primary" id="btnGenEx" style="--lvc:${LEVEL_COLORS[cur]}"><span class="ex-more-pulse" style="background:${LEVEL_COLORS[cur]}"></span>✦ Сгенерировать примеры ${cur}</button>`;
  }

  return `<div><div class="ex-lvl-bar">${lvBtns}</div><div class="ex-lv-desc" style="--lv-border:${LEVEL_COLORS[cur]}">${LEVEL_DESC[cur]}</div><div id="examplesBody">${bodyHtml}</div></div>`;
}

function bindExamplesEvents(c) {
  document.querySelectorAll('.ex-lv-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      state.exLevel=btn.dataset.lv; state.exViewIdx=0;
      const id2=state.selected;
      if (!exCache[id2]?.[btn.dataset.lv]?.length && !state.exLoading) generateExamples(c,btn.dataset.lv,false);
      else refreshExTab(c);
    });
  });
  const btnGen=document.getElementById('btnGenEx');
  if (btnGen) btnGen.addEventListener('click',()=>generateExamples(c,state.exLevel||'B1',false));
  const btnMore=document.getElementById('btnMoreEx');
  if (btnMore) btnMore.addEventListener('click',()=>generateExamples(c,state.exLevel||'B1',true));
  const btnPrev=document.getElementById('exPrev');
  const btnNext=document.getElementById('exNext');
  if (btnPrev) btnPrev.addEventListener('click',()=>{ state.exViewIdx=Math.max(0,(state.exViewIdx||0)-1); refreshExTab(c); });
  if (btnNext) btnNext.addEventListener('click',()=>{ const cached=exCache[state.selected]?.[state.exLevel||'B1']||[]; state.exViewIdx=Math.min(cached.length-1,(state.exViewIdx||0)+1); refreshExTab(c); });

  // Builtin nav
  const bP=document.getElementById('exPrevB'), bN=document.getElementById('exNextB');
  if (bP||bN) {
    const nav=(dir)=>{
      const b=state._builtin||[]; const idx=Math.max(0,Math.min(b.length-1,(state._builtinIdx||0)+dir));
      state._builtinIdx=idx; const ex=b[idx]; if(!ex) return;
      const de=document.getElementById('builtinDe'), ru=document.getElementById('builtinRu'), cnt=document.getElementById('builtinCounter');
      if(de) de.textContent=ex.de; if(ru) ru.textContent=ex.ru; if(cnt) cnt.textContent=`${idx+1} / ${b.length}`;
      if(bP) bP.disabled=idx===0; if(bN) bN.disabled=idx===b.length-1;
    };
    if(bP) bP.addEventListener('click',()=>nav(-1));
    if(bN) bN.addEventListener('click',()=>nav(1));
  }
}

function refreshExTab(c) {
  const tabIdx=(c.tabs||[]).indexOf('Примеры');
  if (tabIdx<0) return;
  const tc=document.getElementById('tc-'+tabIdx);
  if (tc) { tc.innerHTML=renderExamplesTab(c); bindExamplesEvents(c); }
}

async function generateExamples(c,level,append) {
  const id=state.selected; state.exLoading=true; refreshExTab(c);
  const existing=(exCache[id]?.[level]||[]).map(e=>e.de).join(' | ');
  const avoidStr=existing?`Не повторяй: «${existing.slice(0,300)}»`:'';
  try {
    const raw=await callClaude('Ты учитель немецкого. Отвечай ТОЛЬКО JSON-массивом.',
      `5 примеров для «${c.title}» (${c.sub}). Уровень: ${level}. Грамматика: ${c.rule?.formula||c.title}. ${avoidStr}\nJSON: [{"de":"…","ru":"…","note":"комментарий","parts":[{"w":"слово","r":"S/V/Oa/Od/Adv"}]}]`,1400);
    const parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());
    if (!exCache[id]) exCache[id]={};
    exCache[id][level]=append?[...(exCache[id][level]||[]),...parsed]:parsed;
    state.exViewIdx=append?(exCache[id][level].length-parsed.length):0;
  } catch(e) {
    if (!exCache[id]) exCache[id]={};
    exCache[id][level]=[{de:'Ошибка загрузки.',ru:'',note:'',parts:[]}];
  }
  state.exLoading=false; refreshExTab(c);
}

// ═══════════════════════════════════════════════════════════════════
// EXERCISES TAB
// ═══════════════════════════════════════════════════════════════════

function renderExerciseTab(c,idx) {
  const mode=state.exMode||'free';
  const modeBar=`<div style="display:flex;gap:6px;margin-bottom:14px">
    <button class="ew-mode-btn${mode==='fill'?' active':''}" data-mode="fill">📝 Заполнить</button>
    <button class="ew-mode-btn${mode==='free'?' active':''}" data-mode="free">✍ Писать</button></div>`;
  return `<div>${modeBar}${mode==='free'?renderFreePanel(c):renderFillPanel(c,idx)}</div>`;
}

function renderFillPanel(c,idx) {
  if (!c.exercises?.length) return `<div class="ew-empty"><div class="ew-empty-icon">§</div>Нет упражнений.</div>`;
  const e=c.exercises[idx];
  const dots=c.exercises.map((_,i)=>{
    const cls=i<state.exResults.length?(state.exResults[i]?'ok':'bad'):(i===idx?'cur':'');
    return `<div class="ew-dot ${cls}"></div>`;
  }).join('');
  return `<div style="font-size:0.52rem;color:var(--dim);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px">${idx+1} / ${c.exercises.length}</div>
    <div class="ew-dots">${dots}</div>
    <div style="font-family:'EB Garamond',serif;font-size:1.05rem;line-height:1.6;margin-bottom:12px">${e.q.replace(/___/g,'<span style="color:var(--gold);border-bottom:2px solid var(--gold);padding:0 4px">___</span>')}</div>
    <input class="ew-inp" id="ewInp" type="text" placeholder="Ваш ответ…" autocomplete="off" spellcheck="false"/>
    <div class="ew-btns" style="margin-top:8px"><button class="ew-btn-check" id="ewCheck">Проверить</button><button class="ew-btn-next" id="ewNext">Далее →</button></div>
    <div class="ew-fb" id="ewFb"></div>`;
}

function renderFreePanel(c) {
  const lv=state.freeLevel||'B1';
  const lvBar=LEVELS.map(l=>`<button class="ew-free-lvbtn${l===lv?' active':''}" data-lv="${l}" style="--lvc:${LEVEL_COLORS[l]}">${l}</button>`).join('');

  let taskHtml='';
  if (state.freeLoading) {
    taskHtml=`<div class="ai-loading"><div class="ai-spin"></div><span>${state.freeLoadingMsg||'Создаю задание…'}</span></div>`;
  } else if (state.freeTask) {
    const t=state.freeTask;
    const words=(t.words||[]).map(w=>`<span class="ew-word-chip" onclick="insertFreeWord('${w.replace(/'/g,"\\'")}')">📌 ${w}</span>`).join('');
    taskHtml=`<div class="ew-task" style="--lvc:${LEVEL_COLORS[t.level||lv]}">
      <div class="ew-task-meta"><span class="ew-task-lv">${t.level||lv}</span><span class="ew-task-type">${t.taskType||'Составить'}</span></div>
      <div class="ew-task-instr">${t.instruction||''}</div>
      ${t.hint?`<div class="ew-task-hint">💡 ${t.hint}</div>`:''}
      ${words?`<div class="ew-task-words">${words}</div>`:''}
    </div>`;
  } else {
    taskHtml=`<div class="ew-empty"><div class="ew-empty-icon">✎</div>Выберите уровень — AI создаст задание</div>`;
  }

  let resultHtml='';
  if (state.freeResult && !state.freeLoading) resultHtml=renderFreeResult(state.freeResult);

  const ok=(state.freeStats||{}).ok||0, warn=(state.freeStats||{}).warn||0, bad=(state.freeStats||{}).bad||0;
  const total=ok+warn+bad;
  const stats=total>0?`<div class="ew-stats">
    <div class="ew-stat"><div class="ew-stat-val green">${ok}</div><div class="ew-stat-lbl">Отлично</div></div>
    <div class="ew-stat"><div class="ew-stat-val gold">${warn}</div><div class="ew-stat-lbl">Почти</div></div>
    <div class="ew-stat"><div class="ew-stat-val red">${bad}</div><div class="ew-stat-lbl">Ошибки</div></div>
  </div>`:'';

  const hist=(state.freeHistory||[]).slice(-5).reverse().map(h=>`<div class="ew-hist-item ${h.score}"><div class="ew-hist-sent">${h.sentence}</div><div class="ew-hist-fb">${h.shortFb}</div></div>`).join('');
  const histHtml=hist?`<div class="ew-history"><div class="ew-hist-hdr"><span class="ew-hist-title">История</span><button class="ew-hist-clear" id="ewHistClear">×</button></div>${hist}</div>`:'';
  const showInput=state.freeTask&&!state.freeLoading;

  return `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${lvBar}</div>
    ${taskHtml}${resultHtml}
    ${showInput?`<div class="ew-textarea-wrap"><textarea id="ewFreeInput" class="ew-textarea" placeholder="Напишите предложение…" rows="3" spellcheck="false"></textarea><span class="ew-char-count" id="ewCharCnt">0</span></div>
    <div class="ew-free-btns"><button class="ew-btn-submit" id="ewFreeSubmit">✓ Проверить</button><button class="ew-btn-skip" id="ewFreeSkip">↻ Другое</button></div>`:''}
    ${stats}${histHtml}`;
}

function renderFreeResult(r) {
  const sc=r.score==='perfect'?'ok':r.score==='good'?'warn':'bad';
  const icons={perfect:'✓',good:'≈',errors:'✗'};
  const labels={perfect:'Отлично!',good:'Почти правильно',errors:'Есть ошибки'};
  let sentHtml=r.sentence||'';
  if (r.annotations?.length) {
    let s=r.sentence||'';
    r.annotations.forEach(ann=>{
      if (ann.wrong&&s.includes(ann.wrong)) s=s.replace(ann.wrong,`<span class="ew-ann-err" title="${(ann.explain||'').replace(/"/g,"'")}">${ann.wrong}</span>`);
    });
    sentHtml=s;
  }
  const errs=(r.errors||[]).map(err=>{
    if (typeof err==='string') return `<div class="ew-error-item"><span class="ew-err-tag">!</span><span class="ew-err-text">${err}</span></div>`;
    return `<div class="ew-error-item"><span class="ew-err-tag">${err.type||'!'}</span><span class="ew-err-text">${err.wrong?`<span class="ew-err-wrong">${err.wrong}</span> → <span class="ew-err-right">${err.correct||''}</span><br>`:''}${err.explain||''}</span></div>`;
  }).join('');
  const parts=(r.parts||[]).length?`<div class="ew-parts"><div class="ew-parts-label">Разбор:</div><div class="ew-parts-row">${(r.parts||[]).map(p=>`<div class="ew-part-chip"><span class="pw">${p.w}</span><span class="pr">${p.r}</span></div>`).join('')}</div></div>`:'';

  return `<div class="ew-result ${sc}"><div class="ew-result-header"><span class="ew-result-icon">${icons[r.score]||'?'}</span><span class="ew-result-score-lbl">${labels[r.score]||r.score}</span></div>
    <div class="ew-student-sent">${sentHtml}</div>
    ${r.corrected&&r.corrected!==r.sentence?`<div class="ew-corrected"><div class="ew-corrected-label">Правильно</div><div style="font-family:'EB Garamond',serif;font-size:0.9rem;color:#3ad9a0;line-height:1.5">${r.corrected}</div></div>`:''}
    ${r.feedback?`<div style="font-size:0.68rem;color:var(--dim2);line-height:1.6;margin-bottom:8px">${r.feedback}</div>`:''}
    ${errs?`<div class="ew-errors">${errs}</div>`:''}${parts}
    ${r.tip?`<div class="ew-tip">💡 ${r.tip}</div>`:''}</div>`;
}

// ── EVENT BINDING ─────────────────────────────────────────────────
function bindExEvents(c) {
  document.querySelectorAll('.ew-mode-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      state.exMode=btn.dataset.mode; state.freeResult=null;
      const tabIdx=(c.tabs||[]).indexOf('Упражнения');
      const tc=document.getElementById('tc-'+tabIdx);
      if(tc){tc.innerHTML=renderExerciseTab(c,state.exIdx);bindExEvents(c);}
    });
  });
  if (state.exMode==='free') bindFreeEvents(c); else bindFillEvents(c);
}

function bindFillEvents(c) {
  const inp=document.getElementById('ewInp'), btnC=document.getElementById('ewCheck'), btnN=document.getElementById('ewNext');
  if (!inp||!btnC||!btnN) return;
  inp.focus();
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')btnC.click();});
  btnC.addEventListener('click',()=>{
    if (state.answered) return; state.answered=true;
    const val=inp.value.trim(), e=c.exercises[state.exIdx];
    const ok=val.toLowerCase()===e.a.toLowerCase();
    inp.classList.add(ok?'ok':'bad');
    if(ok) state.score.ok++; else state.score.bad++;
    state.exResults[state.exIdx]=ok;
    const fb=document.getElementById('ewFb');
    if(fb){fb.className='ew-fb '+(ok?'ok':'bad'); fb.innerHTML=ok?`✓ Верно! <em>${e.h||''}</em>`:`✗ Ответ: <strong>${e.a}</strong> — ${e.h||''}`;}
    updateScoreUI();
  });
  btnN.addEventListener('click',()=>{
    if(!state.answered&&inp.value.trim()){btnC.click();return;}
    state.exIdx=(state.exIdx+1)%c.exercises.length;
    if(state.exIdx===0) state.exResults=[];
    state.answered=false;
    const tabIdx=(c.tabs||[]).indexOf('Упражнения');
    const tc=document.getElementById('tc-'+tabIdx);
    if(tc){tc.innerHTML=renderExerciseTab(c,state.exIdx);bindExEvents(c);}
  });
}

function bindFreeEvents(c) {
  document.querySelectorAll('.ew-free-lvbtn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      state.freeLevel=btn.dataset.lv; state.freeResult=null;
      generateFreeTask(c,btn.dataset.lv);
    });
  });
  const inp=document.getElementById('ewFreeInput');
  const btnSub=document.getElementById('ewFreeSubmit');
  const btnSkip=document.getElementById('ewFreeSkip');
  const btnHC=document.getElementById('ewHistClear');
  if (inp) {
    inp.addEventListener('input',()=>{const cc=document.getElementById('ewCharCnt');if(cc)cc.textContent=inp.value.length;});
    inp.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();if(btnSub)btnSub.click();}});
    inp.focus();
  }
  if (btnSub) btnSub.addEventListener('click',()=>checkFreeWriting(c));
  if (btnSkip) btnSkip.addEventListener('click',()=>{state.freeResult=null;generateFreeTask(c,state.freeLevel||'B1');});
  if (btnHC) btnHC.addEventListener('click',()=>{state.freeHistory=[];state.freeResult=null;refreshFreeTab(c);});
}

window.insertFreeWord=function(w){
  const inp=document.getElementById('ewFreeInput');
  if(!inp)return;
  inp.value+=(inp.value&&!inp.value.endsWith(' ')?' ':'')+w+' ';
  inp.focus();
  const cc=document.getElementById('ewCharCnt');if(cc)cc.textContent=inp.value.length;
};

async function generateFreeTask(c,level) {
  state.freeLoading=true; state.freeLoadingMsg=`Создаю задание ${level}…`;
  state.freeTask=null; state.freeResult=null; state.freeTaskNum++;
  refreshFreeTab(c);
  const types=['Составить','Перевести','Продолжить','Описать','Трансформировать'];
  const tt=types[state.freeTaskNum%types.length];
  try {
    const raw=await callClaude('Учитель немецкого. ТОЛЬКО JSON.',
      `Задание для написания немецкого предложения. Тема: «${c.title}» — ${c.sub}. Уровень: ${level}. Грамматика: ${c.rule?.formula||c.title}. Тип: ${tt}.\nJSON: {"instruction":"задание на русском","taskType":"${tt}","hint":"подсказка","level":"${level}","words":["до","5","слов"]}`,500);
    state.freeTask=JSON.parse(raw.replace(/```json|```/g,'').trim());
    state.freeTask.level=level;
  } catch(e) {
    state.freeTask={instruction:`Составьте предложение, используя «${c.title}».`,taskType:'Составить',hint:c.rule?.formula||'',level,words:[]};
  }
  state.freeLoading=false; refreshFreeTab(c);
}

async function checkFreeWriting(c) {
  const inp=document.getElementById('ewFreeInput');
  if(!inp) return;
  const sentence=inp.value.trim();
  if (!sentence){inp.focus();return;}
  state.freeLoading=true; state.freeLoadingMsg='Анализирую…'; state.freeResult=null;
  refreshFreeTab(c);
  const task=state.freeTask;
  try {
    const raw=await callClaude('Учитель немецкого. ТОЛЬКО JSON.',
      `Проверь: «${sentence.replace(/"/g,"'")}». Тема: «${c.title}». Грамматика: ${c.rule?.formula||c.title}. ${task?'Задание: '+task.instruction:''}\nJSON: {"score":"perfect/good/errors","sentence":${JSON.stringify(sentence)},"corrected":"…","feedback":"…","errors":[{"type":"…","wrong":"…","correct":"…","explain":"…"}],"annotations":[{"wrong":"…","explain":"…"}],"parts":[{"w":"…","r":"S/V/Oa/Od/Adv"}],"tip":"…"}`,900);
    const result=JSON.parse(raw.replace(/```json|```/g,'').trim());
    result.sentence=sentence;
    const sc=result.score==='perfect'?'ok':result.score==='good'?'warn':'bad';
    if(!state.freeHistory) state.freeHistory=[];
    state.freeHistory.push({sentence,score:sc,shortFb:result.errors?.length?`<s>${sentence}</s> → <em>${result.corrected||sentence}</em>`:(result.feedback||'')});
    if(!state.freeStats) state.freeStats={ok:0,warn:0,bad:0};
    state.freeStats[sc]++;
    if(sc==='ok'||sc==='warn') state.score.ok++; else state.score.bad++;
    updateScoreUI();
    state.freeResult=result; state.freeLoading=false;
    refreshFreeTab(c);
    if(sc==='ok'||sc==='warn') setTimeout(()=>generateFreeTask(c,task?.level||state.freeLevel||'B1'),2200);
  } catch(e) {
    state.freeLoading=false;
    state.freeResult={score:'errors',sentence,feedback:'Ошибка проверки.',errors:[],parts:[],corrected:''};
    refreshFreeTab(c);
  }
}

function refreshFreeTab(c) {
  const tabIdx=(c.tabs||[]).indexOf('Упражнения');
  const tc=document.getElementById('tc-'+tabIdx);
  if(!tc) return;
  tc.innerHTML=renderExerciseTab(c,state.exIdx);
  bindExEvents(c);
}

function updateScoreUI() {
  const ok=document.getElementById('sc-ok'), bad=document.getElementById('sc-bad');
  if(ok) ok.textContent=state.score.ok;
  if(bad) bad.textContent=state.score.bad;
}

// ═══════════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════════
window.addEventListener('resize', resizeCanvas);
resizeCanvas();
</script>
</body>
</html>
