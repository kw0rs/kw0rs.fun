<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deutsch Rad C1 — Полный тренажёр немецкого</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080810;
  --s1: #0f0f1c;
  --s2: #161625;
  --s3: #1e1e32;
  --border: rgba(255,255,255,0.07);
  --text: #dde0f0;
  --dim: #6a6a90;
  --dim2: #9090b8;
  --past: #d94f3a;
  --past2: #a33020;
  --past3: #7a1a10;
  --present: #3ad9a0;
  --present2: #20a368;
  --future: #3a8fd9;
  --future2: #206aa3;
  --special: #c97ae0;
  --gold: #e0c46a;
  --syntax: #e07a40;
  --nebensatz: #4ae0c0;
  --c1color: #ff6090;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Mono', monospace;
  display: flex; flex-direction: column;
  height: 100vh; overflow: hidden;
}

/* ── NAV ── */
nav {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 32px;
  border-bottom: 1px solid var(--border);
  background: rgba(8,8,16,0.9);
  flex-shrink: 0; z-index: 50;
  flex-wrap: wrap; /* Для мобилок */
}
.logo {
  font-family: 'EB Garamond', serif;
  font-size: 1.4rem; font-weight: 700;
  letter-spacing: 0.08em;
  background: linear-gradient(120deg, var(--past), var(--present), var(--future));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.nav-legend { display: flex; gap: 20px; align-items: center; }
.nl { display: flex; align-items: center; gap: 6px; font-size: 0.6rem; color: var(--dim); letter-spacing: 0.08em; text-transform: uppercase; }
.nd { width: 10px; height: 10px; border-radius: 50%; }
.nav-score { display: flex; gap: 14px; }
.ns { text-align: center; }
.ns-n { font-family: 'EB Garamond', serif; font-size: 1.2rem; }
.ns-l { font-size: 0.5rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.1em; }

/* ── LAYOUT ── */
.layout {
  display: grid;
  grid-template-columns: 1fr 450px; /* Сделал инфо-панель чуть шире */
  flex: 1; overflow: hidden;
}

/* ── WHEEL PANEL ── */
.wheel-panel {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 20px; gap: 16px;
  position: relative; overflow: hidden;
}
.wheel-panel::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at center, rgba(58,137,217,0.04) 0%, transparent 70%);
  pointer-events: none;
}
/* Адаптивный враппер для колеса */
.wheel-wrap { position: relative; width: 100%; max-width: 800px; aspect-ratio: 1; flex-shrink: 0; margin: 0 auto; }
#wc { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer; }
.w-center {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  width: 17.5%; height: 17.5%; border-radius: 50%;
  background: var(--bg); border: 1px solid var(--border);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  font-size: clamp(0.7rem, 2vw, 1.2rem); color: var(--dim); text-align: center;
  line-height: 1.5; letter-spacing: 0.06em; text-transform: uppercase;
  pointer-events: none; z-index: 5;
  transition: all 0.3s;
}

/* breadcrumb */
.bc {
  display: flex; align-items: center; gap: 6px;
  font-size: 0.6rem; color: var(--dim); flex-wrap: wrap;
  min-height: 20px;
}
.bc-item { cursor: pointer; transition: color 0.2s; padding: 2px 6px; border-radius: 3px; }
.bc-item:hover { color: var(--text); background: var(--s2); }
.bc-sep { opacity: 0.35; }
.btn-back {
  font-family: 'DM Mono', monospace;
  font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase;
  padding: 6px 16px; background: transparent;
  border: 1px solid var(--border); color: var(--dim);
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
}
.btn-back:hover { border-color: var(--dim2); color: var(--text); }

/* ── INFO PANEL ── */
.info-panel {
  background: var(--s1);
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow: hidden;
}
.ip-head {
  padding: 22px 28px 18px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.ip-tag { font-size: 0.55rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--dim); margin-bottom: 6px; }
.ip-title { font-family: 'EB Garamond', serif; font-size: 2rem; font-weight: 700; line-height: 1.1; }
.ip-sub { font-size: 0.65rem; color: var(--dim); margin-top: 5px; font-style: italic; }
.ip-body { flex: 1; overflow-y: auto; padding: 20px 28px; }
.ip-body::-webkit-scrollbar { width: 3px; }
.ip-body::-webkit-scrollbar-thumb { background: var(--s3); }

/* Cards */
.card {
  background: var(--s2); border-radius: 6px;
  padding: 14px 18px; margin-bottom: 12px;
  border-left: 3px solid transparent;
  animation: fadeUp 0.3s ease;
}
.card.past   { border-color: var(--past); }
.card.present{ border-color: var(--present); }
.card.future { border-color: var(--future); }
.card.special{ border-color: var(--special); }
.card.gold   { border-color: var(--gold); }
.card.syntax { border-color: var(--syntax); }
.card.nebensatz { border-color: var(--nebensatz); }
.card.c1color { border-color: var(--c1color); }
.card h4 { font-size: 0.55rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--dim); margin-bottom: 8px; }
.formula { font-family: 'EB Garamond', serif; font-size: 1rem; color: var(--text); font-weight: 600; margin-bottom: 6px; }
.rule-text { font-size: 0.68rem; line-height: 1.7; color: var(--dim2); }

/* Sentence display */
.sent-block { margin: 6px 0; }
.sent-de {
  font-family: 'EB Garamond', serif; font-size: 1rem;
  color: var(--text); font-weight: 600; line-height: 1.4;
}
.sent-parts { display: flex; flex-wrap: wrap; gap: 4px; margin: 4px 0; }
.part-chip {
  font-size: 0.55rem; padding: 2px 7px; border-radius: 3px;
  background: var(--s3); border: 1px solid var(--border);
  white-space: nowrap;
}
.sent-ru { font-size: 0.65rem; color: var(--dim); margin-top: 2px; }

/* Table */
.gram-table {
  width: 100%; border-collapse: collapse;
  font-size: 0.65rem; margin: 4px 0;
}
.gram-table th {
  background: var(--s3); color: var(--dim);
  font-size: 0.5rem; letter-spacing: 0.08em; text-transform: uppercase;
  padding: 6px 8px; text-align: left;
}
.gram-table td { padding: 5px 8px; border-top: 1px solid var(--border); }
.gram-table tr:hover td { background: var(--s3); }
.gram-table .hl { color: var(--gold); font-weight: 500; }
.gram-table .de { font-family: 'EB Garamond', serif; font-size: 0.8rem; color: var(--text); }

/* Exercise */
.ex-area { background: var(--s2); border-radius: 6px; padding: 16px 18px; margin-top: 8px; animation: fadeUp 0.3s ease; }
.ex-area h4 { font-size: 0.55rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--dim); margin-bottom: 12px; }
.ex-q { font-family: 'EB Garamond', serif; font-size: 1rem; color: var(--text); line-height: 1.6; margin-bottom: 12px; }
.blank { border-bottom: 2px solid var(--gold); color: var(--gold); padding: 0 4px; }
.ex-inp {
  width: 100%; background: var(--bg); border: 1px solid var(--border);
  color: var(--text); padding: 9px 12px;
  font-family: 'DM Mono', monospace; font-size: 0.78rem;
  border-radius: 4px; outline: none; transition: border-color 0.2s;
}
.ex-inp:focus { border-color: var(--gold); }
.ex-inp.ok { border-color: var(--present); color: var(--present); }
.ex-inp.bad { border-color: var(--past); color: var(--past); }
.ex-btns { display: flex; gap: 8px; margin-top: 8px; }
.btn-check {
  padding: 8px 18px; background: var(--gold); color: var(--bg);
  border: none; font-family: 'DM Mono', monospace; font-size: 0.62rem;
  font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase;
  cursor: pointer; border-radius: 4px; transition: opacity 0.2s;
}
.btn-check:hover { opacity: 0.85; }
.btn-next {
  padding: 8px 16px; background: transparent;
  border: 1px solid var(--border); color: var(--dim);
  font-family: 'DM Mono', monospace; font-size: 0.62rem;
  letter-spacing: 0.1em; text-transform: uppercase;
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
}
.btn-next:hover { border-color: var(--dim2); color: var(--text); }
.ex-fb { margin-top: 8px; font-size: 0.68rem; min-height: 16px; line-height: 1.5; }
.ex-fb.ok { color: var(--present); }
.ex-fb.bad { color: var(--past); }
.ex-progress { display: flex; gap: 3px; margin-bottom: 10px; }
.ep-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--s3); transition: background 0.3s; }
.ep-dot.ok { background: var(--present); }
.ep-dot.bad { background: var(--past); }
.ep-dot.cur { background: var(--gold); }

/* Tabs */
.tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
.tab { padding: 8px 16px; font-size: 0.6rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--dim); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s; }
.tab.active { color: var(--text); border-color: var(--gold); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Placeholder */
.ph { text-align: center; padding: 50px 20px; color: var(--dim); }
.ph-icon { font-family: 'EB Garamond', serif; font-size: 3rem; opacity: 0.12; margin-bottom: 16px; }
.ph p { font-size: 0.68rem; line-height: 1.8; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ── AI LOADING / EXAMPLE NOTES ── */
.ai-loading { display: flex; align-items: center; gap: 10px; padding: 16px; color: var(--dim2); font-size: 0.65rem; animation: fadeUp 0.3s ease; }
.ai-spin { width: 16px; height: 16px; flex-shrink: 0; border: 2px solid var(--border); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.ex-note { font-size: 0.55rem; color: var(--gold); background: rgba(224,196,106,0.1); padding: 1px 6px; border-radius: 3px; margin-left: 6px; font-style: normal; letter-spacing: 0.05em; }
.chip-s { color: #3ad9a0; } .chip-v { color: #e0c46a; } .chip-o { color: #3a8fd9; }
.chip-a { color: #c97ae0; } .chip-ad{ color: #d94f3a; } .chip-p { color: #e08c3a; } .chip-n { color: #aaa; }

/* ── МОБИЛЬНАЯ АДАПТАЦИЯ (Медиазапросы) ── */
@media (max-width: 900px) {
  html, body {
    height: auto;
    min-height: 100vh;
    overflow-y: auto; 
    overflow-x: hidden;
    display: block;
  }
  .layout {
    display: flex;
    flex-direction: column;
    height: auto;
    overflow: visible;
  }
  nav {
    padding: 10px 15px;
  }
  .logo {
    font-size: 1.2rem;
  }
  .nav-legend {
    width: 100%;
    order: 3;
    justify-content: center;
    padding-top: 10px;
    margin-top: 5px;
    border-top: 1px solid rgba(255,255,255,0.05);
    flex-wrap: wrap;
    gap: 8px;
  }
  .nl { font-size: 0.55rem; }
  .nav-score {
    margin-left: auto;
  }
  .wheel-panel {
    padding: 15px;
    min-height: auto;
    border-bottom: 1px solid var(--border);
  }
  .wheel-wrap {
    max-width: 500px; /* чуть меньше для мобилок чтобы было эстетичней */
  }
  .w-center {
    font-size: clamp(0.7rem, 3.5vw, 1.3rem);
  }
  .info-panel {
    border-left: none;
    overflow: visible;
  }
  .ip-body {
    overflow: visible;
    padding: 15px;
  }
}
</style>
</head>
<body>

<nav>
  <div class="logo">Deutsch Rad C1</div>
  <div class="nav-legend">
    <div class="nl"><div class="nd" style="background:var(--past)"></div>Vergangenheit</div>
    <div class="nl"><div class="nd" style="background:var(--present)"></div>Gegenwart/Verb</div>
    <div class="nl"><div class="nd" style="background:var(--future)"></div>Zukunft</div>
    <div class="nl"><div class="nd" style="background:var(--special)"></div>Modus/Nomen</div>
    <div class="nl"><div class="nd" style="background:var(--syntax)"></div>Syntax</div>
    <div class="nl"><div class="nd" style="background:var(--nebensatz)"></div>Nebensatz</div>
    <div class="nl"><div class="nd" style="background:var(--c1color)"></div>C1</div>
  </div>
  <div class="nav-score">
    <div class="ns"><div class="ns-n" id="sc-ok" style="color:var(--present)">0</div><div class="ns-l">верно</div></div>
    <div class="ns"><div class="ns-n" id="sc-bad" style="color:var(--past)">0</div><div class="ns-l">ошибок</div></div>
  </div>
</nav>

<div class="layout">
  <div class="wheel-panel">
    <div class="wheel-wrap">
      <canvas id="wc" width="800" height="800"></canvas>
      <div class="w-center" id="wCenter">Deutsch<br>Rad</div>
    </div>
    <div class="bc" id="bc"></div>
    <button class="btn-back" id="btnBack" style="display:none">← Назад</button>
  </div>

  <div class="info-panel">
    <div class="ip-head">
      <div class="ip-tag" id="ipTag">Нажмите на сегмент · <span style="color:var(--c1color)">C1 Niveau</span></div>
      <div class="ip-title" id="ipTitle">Deutsch Rad C1</div>
      <div class="ip-sub" id="ipSub">Полный курс немецкого от A1 до C1 — все темы, все структуры</div>
    </div>
    <div class="ip-body" id="ipBody">
      <div class="ph">
        <div class="ph-icon">⊙</div>
        <p>
          Кликните любой сегмент колеса — он фрактально раскрывается.<br><br>
          <b style="color:var(--past)">Красное</b> — Vergangenheit (Perf./Prät./Plusquamp.)<br>
          <b style="color:var(--future)">Синее</b> — Futur I + II<br>
          <b style="color:var(--present)">Зелёное</b> — Präsens, Verblehre<br>
          <b style="color:var(--special)">Фиолетовое</b> — Konjunktiv, Nomen+Adj.<br>
          <b style="color:var(--syntax)">Оранжевое</b> — Satzbau, Syntax<br>
          <b style="color:var(--nebensatz)">Бирюзовое</b> — Nebensätze (12 типов)<br>
          <b style="color:var(--c1color)">Розовое</b> — C1-Strukturen<br><br>
          Каждый узел: <em>правило · таблица · примеры с разбором · упражнения</em>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════
// DATA LAYER — полная фрактальная структура
// ═══════════════════════════════════════════════════════════════════

// Цветовые зоны
const Z = {
  PAST:'past', PRESENT:'present', FUTURE:'future', SPECIAL:'special',
  SYNTAX:'syntax', NEB:'nebensatz', C1:'c1color'
};

// 12 корневых сегментов
const ROOT_SEGS = [
  { id:'prasens',     label:'Präsens',       sub:'Настоящее',      color:'#3ad9a0', zone:Z.PRESENT },
  { id:'futur1',      label:'Futur I+II',    sub:'Будущее',        color:'#3a8fd9', zone:Z.FUTURE  },
  { id:'perfekt',     label:'Perfekt',       sub:'Прошедшее (речь)',color:'#d94f3a', zone:Z.PAST   },
  { id:'prateritum',  label:'Präteritum',    sub:'Нарратив',       color:'#b03020', zone:Z.PAST   },
  { id:'plusquamp',   label:'Plusquamperf.', sub:'Давнопрошедшее', color:'#7a1a10', zone:Z.PAST   },
  { id:'konjunktiv',  label:'Konjunktiv',    sub:'Сослагательное', color:'#c97ae0', zone:Z.SPECIAL},
  { id:'imperativ',   label:'Imperativ',     sub:'Повелительное',  color:'#e08c3a', zone:Z.SPECIAL},
  { id:'satzbau',     label:'Satzbau',       sub:'Синтаксис',      color:'#e07a40', zone:Z.SYNTAX },
  { id:'verblehre',   label:'Verblehre',     sub:'Глаголы',        color:'#e0c46a', zone:Z.PRESENT},
  { id:'nomenlehre',  label:'Nomen+Adj.',    sub:'Сущ. и прилаг.', color:'#c97ae0', zone:Z.SPECIAL},
  { id:'nebensatz',   label:'Nebensätze',    sub:'Придаточные',    color:'#4ae0c0', zone:Z.NEB    },
  { id:'c1strukt',    label:'C1-Strukt.',    sub:'Уровень C1',     color:'#ff6090', zone:Z.C1     },
];

const CHILDREN = {
  prasens: [
    { id:'pra_aussage',  label:'Aussagesatz',  sub:'Утвердительное' },
    { id:'pra_frage_j',  label:'Ja/Nein-Frage',sub:'Общий вопрос'  },
    { id:'pra_frage_w',  label:'W-Frage',      sub:'Специальный'   },
    { id:'pra_neg',      label:'Negation',     sub:'Отрицание'     },
    { id:'pra_verb',     label:'Verb',         sub:'Спряжение'     },
    { id:'pra_nomen',    label:'Nomen',        sub:'Падежи'        },
    { id:'pra_adj',      label:'Adjektiv',     sub:'Склонение'     },
    { id:'pra_prap',     label:'Präposition',  sub:'Предлоги'      },
  ],
  futur1: [
    { id:'fut1_aussage', label:'Futur I',      sub:'Утвердительное' },
    { id:'fut1_frage',   label:'Frage',        sub:'Вопрос'        },
    { id:'fut1_neg',     label:'Negation F1',  sub:'Отрицание'     },
    { id:'fut1_werden',  label:'werden',       sub:'Спряжение'     },
    { id:'fut2_aussage', label:'Futur II',     sub:'Утвердительное'},
    { id:'fut2_neg',     label:'Negation F2',  sub:'Отрицание FII' },
  ],
  perfekt: [
    { id:'pf_aussage',   label:'Aussagesatz',  sub:'Утвердительное' },
    { id:'pf_frage',     label:'Frage',        sub:'Вопрос'        },
    { id:'pf_neg',       label:'Negation',     sub:'Отрицание'     },
    { id:'pf_haben',     label:'haben',        sub:'haben-Verben'  },
    { id:'pf_sein',      label:'sein',         sub:'sein-Verben'   },
    { id:'pf_part2',     label:'Partizip II',  sub:'Образование'   },
  ],
  prateritum: [
    { id:'prat_aussage', label:'Aussagesatz',  sub:'Утвердительное' },
    { id:'prat_frage',   label:'Frage',        sub:'Вопрос'        },
    { id:'prat_neg',     label:'Negation',     sub:'Отрицание'     },
    { id:'prat_schwach', label:'Schwache V.',  sub:'Слабые'        },
    { id:'prat_stark',   label:'Starke V.',    sub:'Сильные'       },
    { id:'prat_modal',   label:'Modalverben',  sub:'Модальные'     },
  ],
  plusquamp: [
    { id:'plq_aussage',  label:'Aussagesatz',  sub:'Утвердительное' },
    { id:'plq_neg',      label:'Negation',     sub:'Отрицание'     },
  ],
  konjunktiv: [
    { id:'konj2',        label:'Konj. II',     sub:'Нереальное'    },
    { id:'konj2_wurd',   label:'würde+Inf',    sub:'Описательная'  },
    { id:'konj1',        label:'Konj. I',      sub:'Косв. речь'    },
    { id:'konj_irrealis', label:'Irrealis',    sub:'Условие'       },
  ],
  imperativ: [
    { id:'imp_du',       label:'du-Form',      sub:'Ты'            },
    { id:'imp_ihr',      label:'ihr-Form',     sub:'Вы (мн.)'      },
    { id:'imp_sie',      label:'Sie-Form',     sub:'Вы (вежл.)'    },
    { id:'imp_neg',      label:'Negation',     sub:'Запрет'        },
  ],
  pra_aussage: [
    { id:'pra_aus_wort',  label:'Wortstellung', sub:'Порядок слов' },
    { id:'pra_aus_subj',  label:'Subjekt',      sub:'Подлежащее'   },
    { id:'pra_aus_verb',  label:'Verb (Pos.2)', sub:'Глагол'       },
    { id:'pra_aus_obj_a', label:'Akk.-Objekt',  sub:'Вин. падеж'   },
    { id:'pra_aus_obj_d', label:'Dat.-Objekt',  sub:'Дат. падеж'   },
    { id:'pra_aus_adv',   label:'Adverb',       sub:'Обстоятельство'},
  ],
  pf_haben: [
    { id:'pf_haben_trans',  label:'Transitiv',   sub:'Переходные'   },
    { id:'pf_haben_refl',   label:'Reflexiv',    sub:'Возвратные'   },
    { id:'pf_haben_modal',  label:'Modalverben', sub:'Модальные'    },
  ],
  pra_verb: [
    { id:'verb_schwach',  label:'Schwache V.',  sub:'Слабые'       },
    { id:'verb_stark',    label:'Starke V.',    sub:'Сильные'      },
    { id:'verb_modal',    label:'Modalverben',  sub:'Модальные'    },
    { id:'verb_trenn',    label:'Trennbare V.', sub:'Отделяемые'   },
    { id:'verb_refl',     label:'Reflexive V.', sub:'Возвратные'   },
  ],
  pra_nomen: [
    { id:'nom_genus',     label:'Genus',        sub:'Род'          },
    { id:'nom_plural',    label:'Plural',       sub:'Мн. число'    },
    { id:'nom_kasus',     label:'4 Kasus',      sub:'Все падежи'   },
    { id:'nom_gen',       label:'Genitiv',      sub:'Родит. падеж' },
  ],
  satzbau: [
    { id:'sb_v2',         label:'V2-Prinzip',   sub:'Глагол на P2' },
    { id:'sb_klammer',    label:'Satzklammer',  sub:'Рамка'        },
    { id:'sb_mittelfeld', label:'Mittelfeld',   sub:'Серед. поле'  },
    { id:'sb_tekamolo',   label:'TeKaMoLo',     sub:'Порядок обст.'},
    { id:'sb_inversion',  label:'Inversion',    sub:'Инверсия'     },
    { id:'sb_fragesatz',  label:'Fragesätze',   sub:'Вопросы'      },
    { id:'sb_negation',   label:'Negation',     sub:'Отрицание'    },
    { id:'sb_valenz',     label:'Valenz',       sub:'Управление'   },
  ],
  verblehre: [
    { id:'vl_schwach',    label:'Schwache V.',  sub:'Слабые'       },
    { id:'vl_stark',      label:'Starke V.',    sub:'Сильные'      },
    { id:'vl_modal',      label:'Modalverben',  sub:'Модальные'    },
    { id:'vl_trenn',      label:'Trennbare',    sub:'Отделяемые'   },
    { id:'vl_refl',       label:'Reflexive',    sub:'Возвратные'   },
    { id:'vl_untrenn',    label:'Untrennbare',  sub:'Неотделяемые' },
    { id:'vl_passiv',     label:'Passiv',       sub:'Страд. залог' },
    { id:'vl_praepobj',   label:'Präp.Objekte', sub:'Управление'   },
  ],
  nomenlehre: [
    { id:'nl_genus',      label:'Genus',        sub:'Род'          },
    { id:'nl_plural',     label:'Plural',       sub:'Мн. число'    },
    { id:'nl_kasus4',     label:'4 Kasus',      sub:'Падежи'       },
    { id:'nl_adj_dekl',   label:'Adj.Deklination',sub:'Прилаг.'    },
    { id:'nl_adj_komp',   label:'Komparation',  sub:'Степени'      },
    { id:'nl_pronomen',   label:'Pronomen',     sub:'Местоимения'  },
    { id:'nl_praep',      label:'Präpositionen',sub:'Предлоги'     },
    { id:'nl_nominalis',  label:'Nominalisierung',sub:'Номинализ.'  },
  ],
  nebensatz: [
    { id:'ns_dass',       label:'dass-Satz',    sub:'что...'       },
    { id:'ns_weil',       label:'weil / da',    sub:'потому что'   },
    { id:'ns_wenn_als',   label:'wenn / als',   sub:'когда'        },
    { id:'ns_ob',         label:'ob-Satz',      sub:'ли...'        },
    { id:'ns_relativ',    label:'Relativsatz',  sub:'Относит.'     },
    { id:'ns_infinitiv',  label:'Infinitivsatz',sub:'um/ohne/statt zu'},
    { id:'ns_konzessiv',  label:'obwohl/trotzdem',sub:'Уступит.'   },
    { id:'ns_temporal',   label:'Temporalsatz', sub:'Временные'    },
    { id:'ns_konditional',label:'wenn/falls',   sub:'Условные'     },
    { id:'ns_kausal',     label:'Kausalsatz',   sub:'Причинные'    },
    { id:'ns_konsekutiv', label:'sodass',       sub:'Следственные' },
    { id:'ns_final',      label:'damit/um zu',  sub:'Целевые'      },
  ],
  c1strukt: [
    { id:'c1_partizip',   label:'Partizipialsatz',sub:'Прич. оборот'},
    { id:'c1_erw_adj',    label:'Erw.Adj.Attr.',sub:'Расш. опред.' },
    { id:'c1_fvg',        label:'Funktionsverbgef.',sub:'ФГС'      },
    { id:'c1_doppelkonj', label:'Doppelkonjunkt.',sub:'Двойн. союзы'},
    { id:'c1_passiv_adv', label:'Passiv-Ersatz', sub:'Замены пасс.'},
    { id:'c1_konj2',      label:'Konjunktiv II', sub:'Сослагат.'   },
    { id:'c1_konj1',      label:'Konjunktiv I',  sub:'Косв. речь'  },
    { id:'c1_modalsubj',  label:'Subj.Modalität',sub:'Субъ. модаль.'},
    { id:'c1_stil',       label:'Stilmittel',    sub:'Стилистика'  },
  ],
  vl_modal: [
    { id:'vm_bedeutung',  label:'Bedeutungen',  sub:'Значения'     },
    { id:'vm_praesens',   label:'Präsens/Prät.',sub:'Спряжение'    },
    { id:'vm_konjunktiv', label:'Konj.II',      sub:'Сослагат.'    },
    { id:'vm_subjektiv',  label:'Subj.Gebrauch',sub:'Субъ. употр.' },
  ],
  vl_passiv: [
    { id:'pas_vorgang',   label:'Vorgangspassiv',sub:'werden-Pass.'},
    { id:'pas_zustand',   label:'Zustandspassiv',sub:'sein-Pass.'  },
    { id:'pas_modal',     label:'Passiv+Modal',  sub:'С модальными'},
    { id:'pas_zeiten',    label:'Alle Zeiten',   sub:'Все времена' },
  ],
  nl_adj_dekl: [
    { id:'adj_schwach',   label:'Schwach',      sub:'После def.Art.'},
    { id:'adj_stark',     label:'Stark',        sub:'Без артикля'  },
    { id:'adj_gemischt',  label:'Gemischt',     sub:'После indef.' },
    { id:'adj_praedik',   label:'Prädikativ',   sub:'Сказуемостн.' },
  ],
  nl_praep: [
    { id:'pr_akk_dat',    label:'Akk+Dat Präp.',sub:'Akk/Dat'      },
    { id:'pr_wechsel',    label:'Wechselpräp.', sub:'2 падежа'     },
    { id:'pr_gen_praep',  label:'Gen.-Präp.',   sub:'Родит. падеж' },
    { id:'pr_temporal',   label:'Temporale P.', sub:'Время'        },
  ],
  ns_relativ: [
    { id:'rel_nom_akk',   label:'Nom./Akk.',    sub:'der/den...'   },
    { id:'rel_dat_gen',   label:'Dat./Gen.',    sub:'dem/dessen...' },
    { id:'rel_praep',     label:'mit Präp.',    sub:'mit dem...'   },
    { id:'rel_wo',        label:'wo/worüber',   sub:'Lokale/Pronom.'},
  ],
  c1_konj2: [
    { id:'k2_formen',     label:'Formen',       sub:'Bildung'      },
    { id:'k2_irrealis',   label:'Irrealis',     sub:'Нереальн. усл.'},
    { id:'k2_hoeflich',   label:'Höflichkeit',  sub:'Вежливость'   },
    { id:'k2_vergangen',  label:'Vergangenheit',sub:'Прошедшее'    },
  ],
};

// ═══════════════════════════════════════════════════════════════════
// CONTENT (сокращён для примера, база данных сохранена полная)
// ═══════════════════════════════════════════════════════════════════

const CONTENT = {};
const ex = (q, a, h) => ({q, a, h});
const sent = (de, parts, ru) => ({de, parts, ru});

CONTENT['prasens'] = {
  zone:'present', tag:'Zeitform', title:'Präsens', sub:'Настоящее время — всё уровни',
  tabs: ['Правило','Примеры','Упражнения'],
  rule: {
    formula: 'Subjekt + Verb₂ + (Objekt) + (Adverb/Präp.)',
    text: `Präsens — базовое время немецкого. Глагол всегда стоит на <strong>2-й позиции</strong> (V2-правило).<br>Спряжение: <em>ich -e / du -st / er -t / wir -en / ihr -t / sie -en</em>.`,
    table: {
      head: ['Person','Endung','lernen','fahren','lesen'],
      rows: [
        ['ich','-e','lerne','fahre','lese'],
        ['du','-st','lernst','fährst','liest'],
        ['er/sie','-t','lernt','fährt','liest'],
        ['wir','-en','lernen','fahren','lesen'],
        ['ihr','-t','lernt','fahrt','lest'],
        ['sie/Sie','-en','lernen','fahren','lesen'],
      ]
    }
  },
  examples: [
    sent('Ich lerne jeden Tag Deutsch.',[{w:'Ich',r:'S'},{w:'lerne',r:'V'},{w:'jeden Tag',r:'Adv'},{w:'Deutsch',r:'Oa'}],'Я каждый день учу немецкий.'),
  ],
  exercises: [
    ex('Ich ___ (lernen) jeden Tag.','lerne','ich → -e'),
    ex('Er ___ (fahren) nach München.','fährt','fahren: a→ä, 3.Pers. -t'),
  ]
};

// ... СЮДА ДОЛЖНА БЫТЬ ВСТАВЛЕНА ВСЯ ОСТАЛЬНАЯ БАЗА CONTENT (опущено для лимита символов) ...

// ═══════════════════════════════════════════════════════════════════
// WHEEL ENGINE (Переписан под 800x800 и адаптивность)
// ═══════════════════════════════════════════════════════════════════

const canvas = document.getElementById('wc');
const ctx = canvas.getContext('2d');
// Новые координаты высокого разрешения
const CX=400, CY=400, R_OUT=390, R_IN=70;

let state = {
  level: 'root', path: [], selected: null, hover: null,
  score: {ok:0,bad:0}, exIdx: 0, answered: false, exResults: [], activeTab: 0,
};

function getSegs() {
  if (state.level === 'root') return ROOT_SEGS.map((s,i,arr)=>({
    ...s, sa: (i/arr.length)*Math.PI*2 - Math.PI/2, ea: ((i+1)/arr.length)*Math.PI*2 - Math.PI/2,
  }));
  const ch = CHILDREN[state.level];
  if (!ch) return [];
  const parent = findParent(state.level);
  const baseColor = parent ? parent.color : '#888';
  return ch.map((s,i)=>({
    ...s, color: shiftColor(baseColor, i, ch.length), zone: parent ? parent.zone : 'present',
    sa: (i/ch.length)*Math.PI*2 - Math.PI/2, ea: ((i+1)/ch.length)*Math.PI*2 - Math.PI/2,
  }));
}

function findParent(id) {
  if (id === 'root') return null;
  const rootMatch = ROOT_SEGS.find(r=>r.id===id);
  if (rootMatch) return rootMatch;
  for (const r of ROOT_SEGS) {
    if ((CHILDREN[r.id]||[]).some(c=>c.id===id)) return r;
    for (const c of (CHILDREN[r.id]||[])) {
      if ((CHILDREN[c.id]||[]).some(cc=>cc.id===id)) return c;
    }
  }
  return null;
}

function shiftColor(hex, i, n) {
  const t = n<=1 ? 0.7 : 0.55 + 0.45*(i/(n-1));
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  const h2=(v)=>Math.max(20,Math.min(255,Math.round(v*t))).toString(16).padStart(2,'0');
  return `#${h2(r)}${h2(g)}${h2(b)}`;
}

function drawWheel() {
  ctx.clearRect(0,0,800,800);

  // rings - изменен шаг для 800px
  for (let r=R_OUT; r>R_IN; r-=45) {
    ctx.beginPath(); ctx.arc(CX,CY,r,0,Math.PI*2);
    ctx.strokeStyle='rgba(255,255,255,0.03)'; ctx.lineWidth=1; ctx.stroke();
  }

  const segs = getSegs();
  segs.forEach(s=>{
    const hover = s.id===state.hover;
    const sel = s.id===state.selected;
    const gap = 0.012;
    const r = R_OUT - 4;

    ctx.save();
    ctx.beginPath();
    ctx.moveTo(CX,CY);
    ctx.arc(CX,CY,r,s.sa+gap,s.ea-gap);
    ctx.closePath();

    const mid = (s.sa+s.ea)/2;
    const g = ctx.createLinearGradient(
      CX+R_IN*Math.cos(mid), CY+R_IN*Math.sin(mid),
      CX+r*Math.cos(mid), CY+r*Math.sin(mid)
    );
    const a1 = sel?'28': hover?'18':'0e';
    const a2 = sel?'50': hover?'30':'18';
    g.addColorStop(0, s.color+a1);
    g.addColorStop(1, s.color+a2);
    ctx.fillStyle = g;
    ctx.fill();
    ctx.strokeStyle = sel ? s.color : hover ? s.color+'aa' : s.color+'55';
    ctx.lineWidth = sel ? 2 : 1;
    ctx.stroke();
    ctx.restore();

    // text scaling
    const tr = (R_IN+r)*0.5;
    const tx = CX+tr*Math.cos(mid), ty = CY+tr*Math.sin(mid);
    ctx.save();
    ctx.translate(tx,ty);
    let rot = mid;
    if (rot > Math.PI/2 && rot < Math.PI*1.5) rot += Math.PI;
    ctx.rotate(rot);
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font = `500 15px 'DM Mono'`; // Крупнее
    ctx.fillStyle = sel||hover ? '#fff' : s.color+'dd';
    ctx.fillText(s.label, 0, -8);
    ctx.font = '11px DM Mono';
    ctx.fillStyle = sel ? '#fff9' : '#ffffff44';
    ctx.fillText(s.sub, 0, 8);
    if (CHILDREN[s.id]) {
      ctx.font='11px DM Mono'; ctx.fillStyle=s.color+'77';
      ctx.fillText('▾', 0, 24);
    }
    ctx.restore();
  });

  // center
  ctx.beginPath(); ctx.arc(CX,CY,R_IN+2,0,Math.PI*2);
  ctx.strokeStyle='rgba(255,255,255,0.08)'; ctx.lineWidth=1; ctx.stroke();
}

// Конвертация координат под CSS-масштаб
function getMousePos(e) {
  const r = canvas.getBoundingClientRect();
  const scaleX = canvas.width / r.width;
  const scaleY = canvas.height / r.height;
  return {
    x: (e.clientX - r.left) * scaleX,
    y: (e.clientY - r.top) * scaleY
  };
}

function hitTest(x,y) {
  const dx=x-CX, dy=y-CY;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if (dist<R_IN+2||dist>R_OUT) return null;
  let a=Math.atan2(dy,dx);
  if (a<-Math.PI/2) a+=Math.PI*2;
  const segs=getSegs();
  for (const s of segs) {
    let sa=s.sa, ea=s.ea;
    if (sa<-Math.PI/2){sa+=Math.PI*2;ea+=Math.PI*2;}
    if (a>=sa&&a<=ea) return s;
  }
  return null;
}

canvas.addEventListener('mousemove',e=>{
  const pos = getMousePos(e);
  const s = hitTest(pos.x, pos.y);
  const nid = s ? s.id : null;
  if (nid !== state.hover){state.hover = nid; drawWheel();}
  canvas.style.cursor = s ? 'pointer' : 'default';
});

canvas.addEventListener('mouseleave',()=>{state.hover=null;drawWheel();});

canvas.addEventListener('click',e=>{
  const pos = getMousePos(e);
  const s = hitTest(pos.x, pos.y);
  if (!s) return;
  clickSeg(s);
  
  // Автоскролл на мобилках
  if (window.innerWidth <= 900) {
    setTimeout(() => {
      document.querySelector('.info-panel').scrollIntoView({ behavior: 'smooth' });
    }, 100);
  }
});

function clickSeg(s) {
  state.selected=s.id;
  if (CHILDREN[s.id]) {
    state.path.push({id:s.id,label:s.label,prevLevel:state.level});
    state.level=s.id;
    state.selected=null;
    updateCenter(s.label);
  }
  renderContent(s.id);
  updateBreadcrumb();
  drawWheel();
}

function updateCenter(label) {
  const el=document.getElementById('wCenter');
  el.innerHTML=label.length>10 ? label.slice(0,10)+'..' : label;
  // Убрал жесткий font-size, чтобы работал clamp() в CSS
}

document.getElementById('btnBack').addEventListener('click',goBack);
function goBack() {
  if (!state.path.length) return;
  const prev=state.path.pop();
  state.level=prev.prevLevel;
  state.selected=prev.id;
  updateCenter(state.path.length?state.path[state.path.length-1].label:'Deutsch<br>Rad');
  if (!state.path.length) {
    document.getElementById('wCenter').innerHTML='Deutsch<br>Rad';
  }
  updateBreadcrumb();
  drawWheel();
  renderContent(prev.id);
}

function updateBreadcrumb() {
  const bc=document.getElementById('bc');
  const back=document.getElementById('btnBack');
  if (!state.path.length){bc.innerHTML='';back.style.display='none';return;}
  back.style.display='';
  let html=`<span class="bc-item" onclick="resetWheel()">Корень</span>`;
  state.path.forEach((p,i)=>{
    html+=`<span class="bc-sep">›</span><span class="bc-item" onclick="navTo(${i})">${p.label}</span>`;
  });
  bc.innerHTML=html;
}

window.resetWheel=function(){
  state.level='root'; state.path=[]; state.selected=null;
  document.getElementById('wCenter').innerHTML='Deutsch<br>Rad';
  document.getElementById('btnBack').style.display='none';
  document.getElementById('bc').innerHTML='';
  drawWheel();
  showPlaceholder();
};
window.navTo=function(idx){
  const p=state.path[idx];
  state.path=state.path.slice(0,idx+1);
  state.level=p.id; state.selected=null;
  updateCenter(p.label);
  updateBreadcrumb(); drawWheel();
};

function showPlaceholder() {
  document.getElementById('ipTag').textContent='Нажмите на сегмент';
  document.getElementById('ipTitle').textContent='Deutsches Rad';
  document.getElementById('ipTitle').style.color='';
  document.getElementById('ipSub').textContent='Колесо немецкой грамматики';
  document.getElementById('ipBody').innerHTML=`<div class="ph"><div class="ph-icon">⊙</div>
    <p>Кликните любой сегмент колеса.<br>Каждый раскрывается дальше — фрактально.</p></div>`;
}

function getZoneColor(zone) {
  return {past:'var(--past)',present:'var(--present)',future:'var(--future)',special:'var(--special)'}[zone]||'var(--gold)';
}

function renderContent(id) {
  const c = CONTENT[id] || CONTENT['prasens']; // Fallback for the dummy snippet
  
  state.activeTab=0; state.exIdx=0; state.answered=false; state.exResults=[];
  
  document.getElementById('ipTag').textContent=c.tag;
  document.getElementById('ipTitle').textContent=c.title;
  document.getElementById('ipTitle').style.color=getZoneColor(c.zone);
  document.getElementById('ipSub').textContent=c.sub;

  let html='<div>';
  html+=`<div class="tabs">${(c.tabs||['Правило']).map((t,i)=>
    `<div class="tab${i===0?' active':''}" data-tab="${i}">${t}</div>`).join('')}</div>`;

  (c.tabs||['Правило']).forEach((t,i)=>{
    html+=`<div class="tab-content${i===0?' active':''}" id="tc-${i}">`;
    if (t==='Правило') html+=renderRuleTab(c);
    html+='</div>';
  });

  html+='</div>';
  document.getElementById('ipBody').innerHTML=html;

  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      const idx=+tab.dataset.tab;
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tc-'+idx).classList.add('active');
    });
  });
}

function renderRuleTab(c) {
  const r=c.rule;
  if (!r) return '<p>Нет данных.</p>';
  let h=`<div class="card ${c.zone}">
    <h4>Формула</h4>
    <div class="formula">${r.formula.replace(/\n/g,'<br>')}</div>
    <div class="rule-text">${r.text}</div>
  </div>`;
  if (r.table) {
    h+=`<div class="card gold"><h4>Таблица</h4><table class="gram-table">
      <thead><tr>${r.table.head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
      <tbody>${r.table.rows.map(row=>`<tr>${row.map((cell,i)=>
        `<td class="${i===0?'hl':'de'}">${cell}</td>`).join('')}</tr>`).join('')}</tbody>
    </table></div>`;
  }
  return h;
}

// ═══════════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════════
drawWheel();
</script>
</body>
</html>
