<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Академия Кворса | Оценки</title>

  <!-- Open Graph -->
  <meta property="og:title" content="Академия имени Вильяма Кворса" />
  <meta property="og:description" content="Блин, а прикольный сайтик так-то." />
  <meta property="og:image" content="https://kw0rs.uno/icon/williamkw0rs.jpg" />
  <meta property="og:url" content="https://kw0rs.uno" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Академия Кворса" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Академия имени Вильяма Кворса" />
  <meta name="twitter:description" content="Блин, а прикольный сайтик так-то." />
  <meta name="twitter:image" content="https://kw0rs.uno/icon/williamkw0rs.jpg" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/icon/favicon-16x16.png" />
  <link rel="apple-touch-icon" href="/icon/apple-touch-icon.png" />
  <link rel="manifest" href="/icon/site.webmanifest" />
  <link rel="shortcut icon" href="/icon/favicon.ico" />

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#ef4444'
          }
        }
      }
    }
  </script>

  <!-- AlpineJS -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- WWW редирект -->
  <script>
    if (location.hostname === 'www.kw0rs.uno') {
      location.href = 'https://kw0rs.uno' + location.pathname;
    }
  </script>

  <style>
    body {
      background-color: #1c1c1c;
    }
    .lazy-image {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .lazy-image.loaded {
      opacity: 1;
    }
  </style>
</head>
<body class="text-white font-sans" x-data="app()" x-init="load()">
  <div class="max-w-7xl mx-auto p-4">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">К.А.Л. Кворс Аниме Лист</h1>
      <a href="https://kw0rs.uno/" class="bg-primary hover:bg-red-700 px-4 py-2 rounded">В меню</a>
    </div>

    <!-- Фильтры -->
    <div class="grid gap-4 mb-6">
      <div class="flex flex-wrap gap-2">
        <input type="text" x-model="search" placeholder="Поиск..." class="p-2 rounded bg-neutral-800 border border-neutral-700 min-w-[200px] flex-1">
        <select x-model="category" class="p-2 rounded bg-neutral-800 border border-neutral-700">
          <option value="">Все</option>
          <option value="anime">Аниме</option>
          <option value="movie">Фильмы</option>
          <option value="game">Игры</option>
          <option value="book">Книги</option>
          <option value="cartoon">Мультики</option>
          <option value="show">Сериалы</option>
        </select>
        <select x-model="sort" class="p-2 rounded bg-neutral-800 border border-neutral-700">
          <option value="rating-desc">★ (высокие)</option>
          <option value="rating-asc">★ (низкие)</option>
          <option value="year-desc">Год ↓</option>
          <option value="year-asc">Год ↑</option>
          <option value="title">Название</option>
        </select>
        <button @click="random()" class="bg-primary hover:bg-red-700 px-4 py-2 rounded text-white">Мне повезёт</button>
      </div>
    </div>

    <!-- Список -->
    <div x-show="loading" class="text-center py-10">Загрузка...</div>
    <div x-show="!loading && !error" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <template x-for="item in filtered" :key="item.title + item.year">
        <div @click="modal = item" class="bg-neutral-900 p-4 rounded-xl shadow hover:shadow-xl cursor-pointer">
          <div class="relative aspect-[2/3] w-full rounded overflow-hidden mb-2">
            <div class="absolute inset-0 bg-neutral-700 animate-pulse" x-show="!item.loaded"></div>
            <img :src="item.loaded ? item.image : null" :data-src="item.image" class="lazy-image w-full h-full object-cover" @load="item.loaded = true">
          </div>
          <h2 class="text-xl font-bold truncate" x-text="item.title"></h2>
          <p class="text-sm text-gray-400" x-text="item.type + ' • ' + item.year"></p>
          <p x-text="item.rating != null ? '★ ' + item.rating + '/10' : 'Без оценки'" :class="ratingColor(item.rating)" class="font-bold"></p>
        </div>
      </template>
    </div>

    <!-- Ошибка -->
    <div x-show="error" class="text-center text-red-500 py-6" x-text="error"></div>

    <!-- Модалка -->
    <div x-show="modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4" @click.self="modal = null">
      <div class="bg-neutral-900 p-6 rounded-lg max-w-4xl w-full">
        <h2 class="text-2xl font-bold mb-2" x-text="modal?.title"></h2>
        <p class="text-sm text-gray-400" x-text="modal?.type + ' • ' + modal?.year"></p>
        <p class="font-bold my-2" x-text="modal?.rating != null ? '★ ' + modal?.rating + '/10' : 'Без оценки'" :class="ratingColor(modal?.rating)"></p>
        <template x-if="modal?.description">
          <p class="text-gray-300 mb-2" x-text="modal.description"></p>
        </template>
        <template x-if="modal?.review">
          <p class="text-gray-400 italic" x-text="modal.review"></p>
        </template>
        <button class="mt-4 bg-neutral-700 hover:bg-neutral-600 px-4 py-2 rounded" @click="modal = null">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    function app() {
      return {
        search: '',
        category: '',
        sort: 'rating-desc',
        modal: null,
        error: null,
        loading: true,
        items: [],

        async load() {
          const files = ['anime_data.json', 'movies_data.json', 'games_data.json', 'books_data.json', 'cartoons_data.json'];
          try {
            const data = await Promise.all(files.map(f => fetch(f).then(r => r.json())));
            this.items = data.flat().map(i => ({ ...i, loaded: false }));
            this.loading = false;
            this.lazy();
          } catch (e) {
            this.error = 'Ошибка загрузки: ' + e.message;
          }
        },

        get filtered() {
          let out = this.items.filter(i => i.title.toLowerCase().includes(this.search.toLowerCase()));
          if (this.category) out = out.filter(i => i.type === this.category);
          return out.sort((a, b) => {
            const ra = a.rating ?? -1, rb = b.rating ?? -1;
            const ya = parseInt(a.year) || 0, yb = parseInt(b.year) || 0;
            switch (this.sort) {
              case 'rating-asc': return ra - rb;
              case 'rating-desc': return rb - ra;
              case 'year-asc': return ya - yb;
              case 'year-desc': return yb - ya;
              case 'title': return a.title.localeCompare(b.title);
            }
          });
        },

        random() {
          const arr = this.filtered;
          if (!arr.length) return;
          const i = Math.floor(Math.random() * arr.length);
          this.modal = arr[i];
        },

        ratingColor(r) {
          if (r == null) return 'text-gray-500';
          if (r >= 9.5) return 'text-purple-400';
          if (r >= 8) return 'text-green-400';
          if (r >= 5) return 'text-yellow-400';
          return 'text-red-400';
        },

        lazy() {
          const obs = new IntersectionObserver(entries => {
            entries.forEach(e => {
              if (e.isIntersecting) {
                const img = e.target;
                img.src = img.dataset.src;
                obs.unobserve(img);
              }
            });
          }, { rootMargin: '200px' });

          document.querySelectorAll('img[data-src]').forEach(img => obs.observe(img));
        }
      }
    }
  </script>
</body>
</html>
