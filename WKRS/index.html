<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="К.А.Л. Кворс Аниме Лист - коллекция оценок фильмов, сериалов, аниме и других медиа" />

  <title>Академия Кворса | Оценки</title>

  <!-- Open Graph -->
  <meta property="og:title" content="Академия имени Вильяма Кворса" />
  <meta property="og:description" content="Блин, а прикольный сайтик так-то." />
  <meta property="og:image" content="https://kw0rs.uno/icon/williamkw0rs.jpg" />
  <meta property="og:url" content="https://kw0rs.uno" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Академия Кворса" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Академия имени Вильяма Кворса" />
  <meta name="twitter:description" content="Блин, а прикольный сайтик так-то." />
  <meta name="twitter:image" content="https://kw0rs.uno/icon/williamkw0rs.jpg" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/icon/favicon-16x16.png" />
  <link rel="apple-touch-icon" href="/icon/apple-touch-icon.png" />
  <link rel="manifest" href="/icon/site.webmanifest" />
  <link rel="shortcut icon" href="/icon/favicon.ico" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind & Alpine.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            primary: {
              600: '#ef4444',
              700: '#dc2626',
            },
            dark: {
              800: '#1e1e1e',
              900: '#121212',
            }
          }
        }
      }
    }
  </script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Перегонка www → без www -->
  <script>
    if (location.hostname === 'www.kw0rs.uno') {
      window.location.href = 'https://kw0rs.uno' + location.pathname;
    }
  </script>
  <style>
    :root {
      --header-height: 64px;
    }
    
    body { 
      background-color: #121212;
      color: #f5f5f5;
    }
    
    /* Анимации */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    
    .animate-slide-up {
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    
    /* Стили для lazy loading */
    .lazy-image {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .lazy-image.loaded {
      opacity: 1;
    }
    .lazy-placeholder {
      background: linear-gradient(110deg, #2a2a2a 8%, #3a3a3a 18%, #2a2a2a 33%);
      background-size: 200% 100%;
      animation: shine 1.5s linear infinite;
    }
    @keyframes shine {
      to {
        background-position-x: -200%;
      }
    }
    
    /* Карточки */
    .media-card {
      transition: all 0.2s ease;
      transform-origin: center;
    }
    
    .media-card:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    .media-card:active {
      transform: translateY(0) scale(0.98);
    }
    
    /* Модальное окно */
    .modal-enter-active, .modal-leave-active {
      transition: opacity 0.3s ease;
    }
    
    .modal-enter-from, .modal-leave-to {
      opacity: 0;
    }
    
    .modal-content-enter-active, .modal-content-leave-active {
      transition: all 0.3s ease;
    }
    
    .modal-content-enter-from, .modal-content-leave-to {
      opacity: 0;
      transform: scale(0.95);
    }
    
    /* Кастомный скроллбар */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #2a2a2a;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #4a4a4a;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #5a5a5a;
    }
    
    /* Переключатели в модалке */
    .toggle-btn {
      transition: all 0.2s ease;
      position: relative;
    }
    
    .toggle-btn-active {
      background-color: #ef4444;
      color: white;
    }
    
    .toggle-btn-active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background-color: white;
    }
    
    /* Эффект параллакса для фона */
    .parallax-bg {
      background-attachment: fixed;
      background-position: center;
      background-repeat: no-repeat;
      background-size: cover;
    }
    
    /* Адаптивные отступы */
    @media (max-width: 640px) {
      :root {
        --header-height: 56px;
      }
    }
  </style>
</head>
<body class="min-h-screen" 
      x-data="mediaApp()" 
      x-init="loadItems()"
      :class="{'overflow-hidden': modalItem}">
  
  <!-- Шапка -->
  <header class="sticky top-0 z-40 bg-dark-800/90 backdrop-blur-sm border-b border-dark-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-[var(--header-height)]">
        <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-red-500 to-purple-500 bg-clip-text text-transparent">
          К.А.Л. Кворс Аниме Лист
        </h1>
        <a href="https://kw0rs.uno/" class="btn-primary">
          В меню
        </a>
      </div>
    </div>
  </header>

  <!-- Основное содержимое -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Фильтры и сортировка -->
    <section class="mb-8 animate-fade-in">
      <div class="grid grid-cols-1 gap-4">
        <!-- Строка 1: Поиск и категории -->
        <div class="flex flex-wrap gap-3">
          <div class="flex-1 min-w-[200px]">
            <label for="search" class="sr-only">Поиск</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <input 
                id="search"
                type="text" 
                x-model.debounce.300ms="search" 
                placeholder="Поиск по названию..." 
                class="input-field pl-10"
              />
            </div>
          </div>
          
          <div class="flex-1 min-w-[160px]">
            <label for="category" class="sr-only">Категория</label>
            <div class="relative">
              <select 
                id="category"
                x-model="categoryFilter" 
                class="input-field appearance-none pr-8">
                <option value="">Все категории</option>
                <option value="movie">Фильмы</option>
                <option value="show">Сериалы</option>
                <option value="anime">Аниме</option>
                <option value="game">Игры</option>
                <option value="book">Чтиво</option>
                <option value="cartoon">Мультики</option>
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          </div>
          
          <div class="flex-1 min-w-[160px]">
            <label for="sort" class="sr-only">Сортировка</label>
            <div class="relative">
              <select 
                id="sort"
                x-model="sortKey" 
                class="input-field appearance-none pr-8">
                <option value="rating-desc">Рейтинг (Высокие→Низкие)</option>
                <option value="rating-asc">Рейтинг (Низкие→Высокие)</option>
                <option value="year-desc">Год (Новее)</option>
                <option value="year-asc">Год (Старее)</option>
                <option value="title">Название (A-Z)</option>
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Строка 2: Дополнительные фильтры -->
        <div class="flex flex-wrap gap-3">
          <div class="flex-1 min-w-[120px]">
            <label for="min-rating" class="block text-sm font-medium text-gray-300 mb-1">Рейтинг от</label>
            <div class="relative">
              <input 
                id="min-rating"
                type="number" 
                x-model.number="minRating" 
                placeholder="0" 
                min="0" 
                max="10" 
                class="input-field"
              />
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <span class="text-gray-400">/10</span>
              </div>
            </div>
          </div>
          
          <div class="flex-1 min-w-[120px]">
            <label for="min-year" class="block text-sm font-medium text-gray-300 mb-1">Год от</label>
            <input 
              id="min-year"
              type="number" 
              x-model.number="minYear" 
              placeholder="1900" 
              min="1900" 
              max="2100" 
              class="input-field"
            />
          </div>
          
          <div class="flex-1 min-w-[120px]">
            <label for="max-year" class="block text-sm font-medium text-gray-300 mb-1">Год до</label>
            <input 
              id="max-year"
              type="number" 
              x-model.number="maxYear" 
              placeholder="2025" 
              min="1900" 
              max="2100" 
              class="input-field"
            />
          </div>
          
          <div class="flex-1 min-w-[120px] flex items-end">
            <button 
              @click="pickRandomItem()" 
              class="btn-primary w-full flex items-center justify-center gap-2"
              :disabled="filteredItems.length === 0">
              <svg x-show="!randomLoading" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              <svg x-show="randomLoading" class="animate-spin w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              <span>Мне повезёт</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Индикатор количества найденных элементов -->
      <div class="mt-4 text-sm text-gray-400" x-show="!loading && !error">
        Найдено: <span x-text="filteredItems.length" class="font-medium"></span> из <span x-text="items.length" class="font-medium"></span>
      </div>
    </section>

    <!-- Состояния загрузки и ошибки -->
    <section x-show="loading" class="py-12 text-center animate-fade-in">
      <div class="flex justify-center">
        <svg class="animate-spin h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
      <p class="mt-4 text-xl">Загрузка данных...</p>
    </section>

    <section x-show="error" class="py-12 text-center animate-fade-in">
      <div class="flex justify-center">
        <svg class="h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
      <p class="mt-4 text-xl text-red-400" x-text="error"></p>
      <button @click="loadItems()" class="mt-6 btn-primary">
        Попробовать снова
      </button>
    </section>

    <!-- Сетка медиа-элементов -->
    <section x-show="!loading && !error" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100">
      <!-- Пустое состояние -->
      <div x-show="filteredItems.length === 0" class="py-16 text-center">
        <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="mt-4 text-lg font-medium">Ничего не найдено</h3>
        <p class="mt-2 text-gray-400">Попробуйте изменить параметры фильтрации</p>
        <button @click="resetFilters()" class="mt-4 btn-secondary">
          Сбросить фильтры
        </button>
      </div>
      
      <!-- Сетка элементов -->
      <div x-show="filteredItems.length > 0" 
           class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
           x-data="{ observeItems() {
             const observer = new IntersectionObserver((entries) => {
               entries.forEach(entry => {
                 if (entry.isIntersecting) {
                   const img = entry.target;
                   const src = img.getAttribute('data-src');
                   if (src) {
                     img.setAttribute('src', src);
                     observer.unobserve(img);
                   }
                 }
               });
             }, { rootMargin: '200px 0px' });
             
             this.$nextTick(() => {
               document.querySelectorAll('img[data-src]').forEach(img => {
                 observer.observe(img);
               });
             });
           } }"
           x-init="observeItems()"
           @filter-updated.window="observeItems()">
        
        <template x-for="item in filteredAndSortedItems" :key="item.id">
          <article @click="openModal(item)" 
                  class="media-card group relative bg-dark-800 rounded-xl overflow-hidden shadow hover:shadow-lg transition-all cursor-pointer">
            <!-- Бейдж категории -->
            <div class="absolute top-3 left-3 z-10">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" 
                    :class="getCategoryBadgeClass(item.type)">
                <span x-text="item.typeDisplay"></span>
              </span>
            </div>
            
            <!-- Изображение -->
            <div class="relative w-full aspect-[2/3] bg-dark-700 overflow-hidden">
              <template x-if="item.image">
                <div class="absolute inset-0">
                  <div class="lazy-placeholder absolute inset-0" x-show="!item.imageLoaded"></div>
                  <img 
                    class="lazy-image w-full h-full object-cover transition-opacity duration-300" 
                    :src="item.imageLoaded ? item.image : null"
                    :data-src="!item.imageLoaded ? item.image : null" 
                    @load="(e) => { e.target.classList.add('loaded'); item.imageLoaded = true; }" 
                    @error="handleImageError($event,item)"
                    alt="" 
                    loading="lazy"
                  />
                </div>
              </template>
              <template x-if="!item.image">
                <div class="w-full h-full flex items-center justify-center text-gray-400 p-4 text-center">
                  <div>
                    <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="mt-2 text-sm">Изображение отсутствует</p>
                  </div>
                </div>
              </template>
              
              <!-- Рейтинг -->
              <div class="absolute bottom-3 right-3 z-10">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-dark-900/90 backdrop-blur-sm border border-dark-700 shadow-lg"
                     :class="getRatingBgClass(item)">
                  <span class="font-bold text-sm" x-text="getRatingText(item)"></span>
                </div>
              </div>
            </div>
            
            <!-- Контент карточки -->
            <div class="p-4">
              <h2 class="text-lg font-semibold mb-1 truncate" x-text="item.title"></h2>
              <div class="flex items-center justify-between text-sm text-gray-400">
                <span x-text="item.year"></span>
                <template x-if="item.genres.length > 0">
                  <span class="truncate max-w-[50%]" x-text="item.genres[0]"></span>
                </template>
              </div>
            </div>
          </article>
        </template>
      </div>
    </section>
  </main>

  <!-- Модальное окно -->
  <div x-show="modalItem" 
       x-transition.opacity.duration.300ms
       class="fixed inset-0 z-50 overflow-y-auto"
       @keydown.escape.window="modalItem = null">
    <div class="flex items-center justify-center min-h-screen p-4">
      <!-- Затемнение фона -->
      <div class="fixed inset-0 bg-black/80 transition-opacity" 
           @click="modalItem = null"
           x-transition:enter="ease-out duration-300"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="ease-in duration-200"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0"></div>
      
      <!-- Контент модалки -->
      <div class="relative bg-dark-800 rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden"
           x-transition:enter="ease-out duration-300"
           x-transition:enter-start="opacity-0 scale-95"
           x-transition:enter-end="opacity-100 scale-100"
           x-transition:leave="ease-in duration-200"
           x-transition:leave-start="opacity-100 scale-100"
           x-transition:leave-end="opacity-0 scale-95">
        
        <!-- Кнопка закрытия -->
        <button @click="modalItem = null" 
                class="absolute top-4 right-4 z-10 p-2 rounded-full bg-dark-700 hover:bg-dark-600 transition"
                aria-label="Закрыть">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        
        <div class="flex flex-col md:flex-row h-full">
          <!-- Левая часть (изображение) -->
          <div class="md:w-1/2 bg-dark-900 flex items-center justify-center p-6">
            <template x-if="modalItem.image">
              <img :src="modalItem.image" 
                   class="max-h-[60vh] w-auto rounded-lg shadow-lg object-contain"
                   @error="modalItem.image = null"
                   :alt="modalItem.title">
            </template>
            <template x-if="!modalItem.image">
              <div class="w-full h-64 flex items-center justify-center text-gray-400">
                <div class="text-center">
                  <svg class="mx-auto h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <p class="mt-2">Изображение отсутствует</p>
                </div>
              </div>
            </template>
          </div>
          
          <!-- Правая часть (контент) -->
          <div class="md:w-1/2 p-6 overflow-y-auto">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h2 class="text-2xl font-bold" x-text="modalItem.title"></h2>
                <div class="flex items-center mt-1 space-x-4 text-sm text-gray-400">
                  <span x-text="modalItem.typeDisplay"></span>
                  <span>•</span>
                  <span x-text="modalItem.year"></span>
                </div>
              </div>
              
              <div class="flex items-center justify-center w-14 h-14 rounded-full bg-dark-700 border border-dark-600 shadow"
                   :class="getRatingBgClass(modalItem)">
                <span class="font-bold text-lg" x-text="getRatingText(modalItem)"></span>
              </div>
            </div>
            
            <!-- Жанры -->
            <template x-if="modalItem.genres.length > 0">
              <div class="mb-4">
                <div class="flex flex-wrap gap-2">
                  <template x-for="genre in modalItem.genres">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-dark-700 text-gray-300">
                      <span x-text="genre"></span>
                    </span>
                  </template>
                </div>
              </div>
            </template>
            
            <!-- Переключатель контента -->
            <div class="mb-4" x-show="hasAnyContent">
              <div class="flex rounded-lg bg-dark-700 p-1">
                <!-- Кнопка "Рецензия" -->
                <button 
                  @click="showReview = true" 
                  :class="getToggleButtonClass('review')"
                  :disabled="!modalItem.review"
                  class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition">
                  <span x-show="!modalItem.review">Рецензии нет</span>
                  <span x-show="modalItem.review">Рецензия</span>
                </button>
                
                <!-- Кнопка "Описание" -->
                <button 
                  @click="showReview = false" 
                  :class="getToggleButtonClass('description')"
                  :disabled="!modalItem.description"
                  class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition">
                  <span x-show="!modalItem.description">Описания нет</span>
                  <span x-show="modalItem.description">Описание</span>
                </button>
              </div>
            </div>
            
            <!-- Контент (рецензия или описание) -->
            <div class="prose prose-invert max-w-none" x-show="hasAnyContent">
              <!-- Рецензия -->
              <div x-show="showReview && modalItem.review" x-html="formatText(modalItem.review)"></div>
              
              <!-- Описание -->
              <div x-show="!showReview && modalItem.description" x-html="formatText(modalItem.description)"></div>
              
              <!-- Если выбран таб без контента -->
              <div x-show="(showReview && !modalItem.review) || (!showReview && !modalItem.description)" 
                   class="text-center py-6 text-gray-400">
                <svg class="mx-auto h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="mt-2">Информация отсутствует</p>
              </div>
            </div>
            
            <!-- Сообщение, если нет ни рецензии, ни описания -->
            <div class="py-6 text-center" x-show="!hasAnyContent">
              <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="mt-2 text-gray-400">
                Информация отсутствует
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function mediaApp() {
      return {
        search: '',
        categoryFilter: '',
        sortKey: 'rating-desc',
        modalItem: null,
        items: [],
        loading: true,
        error: null,
        minRating: null,
        minYear: null,
        maxYear: null,
        showReview: true,
        randomLoading: false,
        
        // Загрузка данных
        async loadItems() {
          this.loading = true;
          this.error = null;
          
          try {
            // Используем Promise.all для параллельной загрузки
            const urls = [
              'anime_data.json', 
              'movies_data.json', 
              'games_data.json', 
              'books_data.json', 
              'cartoons_data.json'
            ];
            
            const responses = await Promise.all(urls.map(url => fetch(url)));
            
            // Проверяем все ответы
            for (const res of responses) {
              if (!res.ok) throw new Error(`Ошибка загрузки данных: ${res.status}`);
            }
            
            // Парсим все JSON
            const dataArrays = await Promise.all(responses.map(res => res.json()));
            
            // Объединяем и обрабатываем данные
            this.items = dataArrays.flat().map((i, idx) => ({
              id: idx, // Уникальный ID для ключей
              title: i.title || 'Без названия',
              type: i.type || 'Неизвестно',
              typeDisplay: this.getTypeDisplay(i.type) || 'Неизвестно',
              year: i.year || 'Н/Д',
              rating: !isNaN(parseFloat(i.rating)) ? parseFloat(i.rating) : null,
              genres: Array.isArray(i.genres) ? i.genres : [],
              description: i.description || '',
              review: i.review || '',
              image: i.image || null,
              imageLoaded: false
            }));
            
          } catch (e) {
            console.error('Ошибка загрузки данных:', e);
            this.error = `Не удалось загрузить данные: ${e.message}`;
            this.items = [];
          } finally {
            this.loading = false;
            // Отправляем событие об обновлении фильтров
            this.$dispatch('filter-updated');
          }
        },
        
        // Открытие модального окна
        openModal(item) { 
          this.modalItem = {...item};
          this.showReview = item.review ? true : false;
          // Прокрутка в начало модального окна
          this.$nextTick(() => {
            const modalContent = this.$el.querySelector('.overflow-y-auto');
            if (modalContent) modalContent.scrollTop = 0;
          });
        },
        
        // Обработчик ошибки изображения
        handleImageError(e, item) { 
          item.image = null; 
          item.imageLoaded = false;
        },
        
        // Случайный выбор элемента
        async pickRandomItem() {
          if (this.filteredItems.length === 0) return;
          
          this.randomLoading = true;
          
          // Имитация задержки для лучшего UX
          await new Promise(resolve => setTimeout(resolve, 300));
          
          const randomIndex = Math.floor(Math.random() * this.filteredItems.length);
          this.openModal(this.filteredItems[randomIndex]);
          
          this.randomLoading = false;
        },
        
        // Сброс фильтров
        resetFilters() {
          this.search = '';
          this.categoryFilter = '';
          this.minRating = null;
          this.minYear = null;
          this.maxYear = null;
          this.sortKey = 'rating-desc';
        },
        
        // Форматирование текста (для переносов строк в описаниях)
        formatText(text) {
          return text.replace(/\n/g, '<br>');
        },
        
        // Получение отображаемого текста рейтинга
        getRatingText(item) {
          return (item.rating != null) ? item.rating : '?';
        },
        
        // Классы для рейтинга
        getRatingClass(item) {
          if (item.rating == null) return 'text-gray-400';
          if (item.rating >= 10) return 'text-purple-500 [text-shadow:0_0_8px_rgba(168,85,247,0.8),0_0_16px_rgba(168,85,247,0.6)]';
          if (item.rating >= 7) return 'text-green-400';
          if (item.rating >= 4) return 'text-yellow-400';
          return 'text-red-500';
        },
        
        // Классы для фона рейтинга
        getRatingBgClass(item) {
          if (item.rating == null) return 'text-gray-400';
          if (item.rating >= 10) return 'bg-purple-900/80 text-purple-300';
          if (item.rating >= 7) return 'bg-green-900/80 text-green-300';
          if (item.rating >= 4) return 'bg-yellow-900/80 text-yellow-300';
          return 'bg-red-900/80 text-red-300';
        },
        
        // Классы для бейджей категорий
        getCategoryBadgeClass(type) {
          const typeClasses = {
            'movie': 'bg-blue-900 text-blue-100',
            'show': 'bg-indigo-900 text-indigo-100',
            'anime': 'bg-purple-900 text-purple-100',
            'game': 'bg-green-900 text-green-100',
            'book': 'bg-amber-900 text-amber-100',
            'cartoon': 'bg-pink-900 text-pink-100',
          };
          return typeClasses[type] || 'bg-gray-700 text-gray-100';
        },
        
        // Функция для перевода type в отображаемый текст
        getTypeDisplay(typeValue) {
          const typeMap = {
            'movie': 'Фильм',
            'show': 'Сериал',
            'anime': 'Аниме',
            'game': 'Игра',
            'book': 'Книга',
            'cartoon': 'Мультфильм'
          };
          return typeMap[typeValue] || typeValue;
        },
        
        // Классы для переключателей в модалке
        getToggleButtonClass(type) {
          const isActive = type === 'review' ? this.showReview : !this.showReview;
          const hasContent = type === 'review' ? this.modalItem.review : this.modalItem.description;
          
          if (!hasContent) {
            return 'text-gray-500 cursor-not-allowed';
          }
          
          return isActive 
            ? 'bg-dark-600 text-white shadow' 
            : 'text-gray-300 hover:text-white hover:bg-dark-600/50';
        },
        
        // Проверка наличия контента в модалке
        get hasAnyContent() {
          return this.modalItem && (this.modalItem.review || this.modalItem.description);
        },

        // Фильтрация элементов
        get filteredItems() {
          return this.items
            .filter(i => !this.search || i.title.toLowerCase().includes(this.search.toLowerCase()))
            .filter(i => !this.categoryFilter || i.type === this.categoryFilter)
            .filter(i => this.minRating == null || (i.rating != null && i.rating >= this.minRating))
            .filter(i => this.minYear == null || (i.year !== 'Н/Д' && parseInt(i.year) >= this.minYear))
            .filter(i => this.maxYear == null || (i.year !== 'Н/Д' && parseInt(i.year) <= this.maxYear));
        },

        // Сортировка элементов
        get filteredAndSortedItems() {
          return [...this.filteredItems].sort((a, b) => {
            const ra = (a.rating == null) ? -1 : a.rating;
            const rb = (b.rating == null) ? -1 : b.rating;
            const ya = parseInt(a.year) || 0;
            const yb = parseInt(b.year) || 0;
            
            switch (this.sortKey) {
              case 'rating-asc':   return ra - rb;
              case 'rating-desc':  return rb - ra;
              case 'year-asc':     return ya - yb;
              case 'year-desc':    return yb - ya;
              case 'title':        return a.title.localeCompare(b.title);
              default:            return 0;
            }
          });
        }
      }
    }
  </script>
</body>
</html>
