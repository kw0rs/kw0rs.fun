<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мини Doom 64 | Академия Кворса</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/icon/apple-touch-icon.png">
  <link rel="manifest" href="/icon/site.webmanifest">
  <link rel="shortcut icon" href="/icon/favicon.ico">

  <!-- Перегонка www на без www и перевод пути в нижний регистр -->
  <script>
    if (location.hostname === 'www.kw0rs.fun') {
      window.location.href = 'https://kw0rs.fun' + location.pathname;
    }
    var path = window.location.pathname;
    if (path !== path.toLowerCase()) {
      window.location.pathname = path.toLowerCase();
    }
  </script>

  <style>
    /* Убираем прокрутку и задаём фон */
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
      background: #222;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Функция для установки размеров canvas под окно
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Простая карта: 1 – стена, 0 – пустота
    const map = [
      [1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,1],
      [1,0,1,0,1,0,1,0,0,1],
      [1,0,1,0,1,0,1,0,0,1],
      [1,0,0,0,0,0,1,0,0,1],
      [1,0,1,0,1,0,1,0,0,1],
      [1,0,1,0,1,0,1,0,0,1],
      [1,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1]
    ];
    const mapWidth = map[0].length;
    const mapHeight = map.length;
    const tileSize = 64; // размер клетки

    // Игрок
    let player = {
      x: tileSize * 1.5,
      y: tileSize * 1.5,
      angle: 0
    };

    const fov = Math.PI / 3; // 60° поле зрения
    const numRays = canvas.width; // по одному лучу на пиксель ширины
    const maxDepth = 1000;

    function castRays() {
      for (let i = 0; i < numRays; i++) {
        // Угол луча
        const rayAngle = player.angle - fov / 2 + (i / numRays) * fov;
        let distance = 0;
        let hit = false;
        // Вектор направления
        const eyeX = Math.cos(rayAngle);
        const eyeY = Math.sin(rayAngle);

        while (!hit && distance < maxDepth) {
          distance += 1;
          const testX = Math.floor((player.x + eyeX * distance) / tileSize);
          const testY = Math.floor((player.y + eyeY * distance) / tileSize);
          if (testX < 0 || testX >= mapWidth || testY < 0 || testY >= mapHeight) {
            hit = true;
            distance = maxDepth;
          } else {
            if (map[testY][testX] > 0) {
              hit = true;
            }
          }
        }

        // Коррекция "рыбьего глаза"
        const correctedDistance = distance * Math.cos(rayAngle - player.angle);
        // Вычисление высоты стены
        const lineHeight = (tileSize / correctedDistance) * (canvas.width / 2) / Math.tan(fov / 2);

        // Рисуем вертикальную линию (стену)
        ctx.fillStyle = correctedDistance < maxDepth ? "#888" : "#000";
        ctx.fillRect(i, (canvas.height / 2) - lineHeight / 2, 1, lineHeight);
        
        // (Опционально) можно добавить заливку потолка и пола
        ctx.fillStyle = "#111";
        ctx.fillRect(i, 0, 1, (canvas.height / 2) - lineHeight / 2);
        ctx.fillStyle = "#333";
        ctx.fillRect(i, (canvas.height / 2) + lineHeight / 2, 1, canvas.height / 2 - lineHeight / 2);
      }
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      castRays();
      requestAnimationFrame(gameLoop);
    }
    gameLoop();

    // Управление стрелками
    document.addEventListener("keydown", function(e) {
      const moveSpeed = 5;
      const rotSpeed = 0.05;
      if (e.key === "ArrowUp") {
        player.x += Math.cos(player.angle) * moveSpeed;
        player.y += Math.sin(player.angle) * moveSpeed;
      }
      if (e.key === "ArrowDown") {
        player.x -= Math.cos(player.angle) * moveSpeed;
        player.y -= Math.sin(player.angle) * moveSpeed;
      }
      if (e.key === "ArrowLeft") {
        player.angle -= rotSpeed;
      }
      if (e.key === "ArrowRight") {
        player.angle += rotSpeed;
      }
    });
  </script>
</body>
</html>
